{"version":3,"sources":["turbopack:///[project]/app/login/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useEffect, useRef, useState, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\n\nfunction AuthingLoginComponent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  \n  // 从环境变量读取 Authing App ID\n  const appId = process.env.NEXT_PUBLIC_AUTHING_APP_ID || ''\n  const guardRef = useRef<any>(null)\n  const [isLoaded, setIsLoaded] = useState(false)\n\n  useEffect(() => {\n    // 1. 检查是否已经登录\n    // 如果已经有用户信息，直接跳转，不再显示登录框\n    const user = localStorage.getItem('currentUser')\n    if (user) {\n      const redirectPath = searchParams.get('redirect')\n      router.replace(redirectPath || '/')\n      return\n    }\n\n    if (guardRef.current) return\n\n    // 2. 动态加载 Authing 样式\n    const link = document.createElement('link')\n    link.rel = 'stylesheet'\n    link.href = 'https://cdn.authing.co/packages/guard/latest/guard.min.css'\n    document.head.appendChild(link)\n\n    // 3. 加载 Authing 组件\n    import('@authing/guard').then((module) => {\n      const Guard = module.Guard\n      if (guardRef.current) return\n\n      try {\n        const guard = new Guard({\n          appId,\n          mode: 'normal', // 使用普通模式，不强制跳转\n        })\n\n      // ✅ 登录成功的处理逻辑\n      guard.on('login', async (userInfo: any) => {\n        console.log('登录成功:', userInfo)\n        \n        // [关键] 保存用户信息到浏览器，以便支付页面能看到\n        const finalUser = userInfo.data || userInfo\n        localStorage.setItem('currentUser', JSON.stringify(finalUser))\n\n        // 可选：同步到你的后端数据库 (保留了你之前的逻辑)\n        try {\n          await fetch('/api/auth/sync', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              user_id: finalUser.id || finalUser.sub,\n              email: finalUser.email,\n              nickname: finalUser.nickname || finalUser.username,\n              avatar: finalUser.photo,\n              // ✨ [新增] 同步手机号\n              // Authing 返回的手机号字段可能是 phone 或 phone_number\n              phone: finalUser.phone || finalUser.phone_number \n            })\n          })\n        } catch(e) {\n          console.error('同步失败', e)\n        }\n\n        // [关键] 登录后跳转回刚才的页面（比如支付页）\n        const redirectPath = searchParams.get('redirect')\n        \n        if (redirectPath) {\n          console.log('正在返回之前的页面:', redirectPath)\n          // 使用 decodeURIComponent 确保网址格式正确\n          router.replace(decodeURIComponent(redirectPath))\n        } else {\n          router.replace('/')\n        }\n      })\n\n        guard.start('#authing-guard-container')\n        guardRef.current = guard\n        setIsLoaded(true)\n      } catch (error) {\n        console.error('Authing Guard 初始化失败:', error)\n        setIsLoaded(true) // 即使失败也标记为已加载，避免无限等待\n      }\n    }).catch((error) => {\n      console.error('加载 Authing 模块失败:', error)\n      setIsLoaded(true)\n    })\n  }, [appId, router, searchParams])\n\n  return (\n    <div style={{ \n      height: '100vh', \n      display: 'flex', \n      flexDirection: 'column', \n      justifyContent: 'center', \n      alignItems: 'center', \n      backgroundColor: '#f5f5f5' \n    }}>\n      {/* 登录框容器 */}\n      <div id=\"authing-guard-container\" style={{ minHeight: '500px' }}></div>\n      \n      {!isLoaded && (\n        <p style={{ color: '#666', marginTop: '20px' }}>\n          正在加载安全登录组件...\n        </p>\n      )}\n    </div>\n  )\n}\n\n// 必须使用 Suspense 包裹，否则在 Next.js 新版本中可能会报错\nexport default function LoginPage() {\n  return (\n    <Suspense fallback={<div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>加载中...</div>}>\n      <AuthingLoginComponent />\n    </Suspense>\n  )\n}\n"],"names":[],"mappings":"uDAEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEA,SAAS,IACP,IAAM,EAAS,CAAA,EAAA,EAAA,SAAS,AAAT,IACT,EAAe,CAAA,EAAA,EAAA,eAAA,AAAe,IAG9B,EAAQ,MAAA,qBACR,EAAW,CAAA,CADuC,CACvC,EAAA,MAAA,AAAM,EAAM,MACvB,CAAC,EAAU,EAAY,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,GAAC,GAmFzC,MAjFA,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KAIR,GADa,CACT,YADsB,OAAO,CAAC,eACxB,CACR,IAAM,EAAe,EAAa,GAAG,CAAC,YACtC,EAAO,OAAO,CAAC,GAAgB,KAC/B,MACF,CAEA,GAAI,EAAS,OAAO,CAAE,OAGtB,IAAM,EAAO,SAAS,aAAa,CAAC,QACpC,EAAK,GAAG,CAAG,aACX,EAAK,IAAI,CAAG,6DACZ,SAAS,IAAI,CAAC,WAAW,CAAC,GAG1B,EAAA,CAAA,CAAA,MAAyB,IAAI,CAAC,AAAC,IAC7B,IAAM,EAAQ,EAAO,KAAK,CAC1B,IAAI,EAAS,OAAO,CAEpB,CAFsB,EAElB,CACF,IAAM,EAAQ,IAAI,EAAM,OACtB,EACA,KAAM,QACR,GAGF,EAAM,EAAE,CAAC,QAAS,MAAO,IAIvB,IAAM,EAAY,EAAS,IAAI,EAAI,EACnC,aAAa,OAAO,CAAC,cAAe,KAAK,SAAS,CAAC,IAGnD,GAAI,CACF,MAAM,MAAM,iBAAkB,CAC5B,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,CACnB,QAAS,EAAU,EAAE,EAAI,EAAU,GAAG,CACtC,MAAO,EAAU,KAAK,CACtB,SAAU,EAAU,QAAQ,EAAI,EAAU,QAAQ,CAClD,OAAQ,EAAU,KAAK,CAGvB,MAAO,EAAU,KAAK,EAAI,EAAU,YAAY,AAClD,EACF,EACF,CAAE,MAAM,EAAG,CACT,QAAQ,KAAK,CAAC,OAAQ,EACxB,CAGA,IAAM,EAAe,EAAa,GAAG,CAAC,YAElC,EAGF,EAAO,OAAO,CAAC,EAHC,iBAGkB,IAElC,EAAO,OAAO,CAAC,IAEnB,GAEE,EAAM,KAAK,CAAC,4BACZ,EAAS,OAAO,CAAG,EACnB,GAAY,EACd,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,uBAAwB,GACtC,GAAY,EACd,CACF,GAAG,CAFmB,IAEd,CAAC,AAAC,IACR,QAAQ,IAHiC,CAG5B,CAAC,mBAAoB,GAClC,GAAY,EACd,EACF,EAAG,CAAC,EAAO,EAAQ,EAAa,EAG9B,CAAA,EAAA,EAAA,IAAA,EAAC,MAAA,CAAI,MAAO,CACV,OAAQ,QACR,QAAS,OACT,cAAe,SACf,eAAgB,SAChB,WAAY,SACZ,gBAAiB,SACnB,YAEE,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,GAAG,0BAA0B,MAAO,CAAE,UAAW,OAAQ,IAE7D,CAAC,GACA,CAAA,EAAA,EAAA,GAAA,EAAC,IAAA,CAAE,MAAO,CAAE,MAAO,OAAQ,UAAW,MAAO,WAAG,oBAMxD,CAGe,SAAS,IACtB,MACE,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,QAAQ,CAAA,CAAC,SAAU,CAAA,EAAA,EAAA,GAAA,EAAC,MAAA,CAAI,MAAO,CAAE,OAAQ,QAAS,QAAS,OAAQ,eAAgB,SAAU,WAAY,QAAS,WAAG,oBACpH,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,CAAA,IAGP"}