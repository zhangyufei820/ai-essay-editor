{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/login/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useEffect, useRef, useState, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\n\nfunction AuthingLoginComponent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  \n  // 这是你之前提供的 Authing App ID\n  const appId = '692b0bd30de159be78db726b' \n  const guardRef = useRef<any>(null)\n  const [isLoaded, setIsLoaded] = useState(false)\n\n  useEffect(() => {\n    // 1. 检查是否已经登录\n    // 如果已经有用户信息，直接跳转，不再显示登录框\n    const user = localStorage.getItem('currentUser')\n    if (user) {\n      const redirectPath = searchParams.get('redirect')\n      router.replace(redirectPath || '/')\n      return\n    }\n\n    if (guardRef.current) return\n\n    // 2. 动态加载 Authing 样式\n    const link = document.createElement('link')\n    link.rel = 'stylesheet'\n    link.href = 'https://cdn.authing.co/packages/guard/latest/guard.min.css'\n    document.head.appendChild(link)\n\n    // 3. 加载 Authing 组件\n    import('@authing/guard').then((module) => {\n      const Guard = module.Guard\n      if (guardRef.current) return\n\n      const guard = new Guard({\n        appId,\n        mode: 'normal', // 使用普通模式，不强制跳转\n      })\n\n      // ✅ 登录成功的处理逻辑\n      guard.on('login', async (userInfo: any) => {\n        console.log('登录成功:', userInfo)\n        \n        // [关键] 保存用户信息到浏览器，以便支付页面能看到\n        const finalUser = userInfo.data || userInfo\n        localStorage.setItem('currentUser', JSON.stringify(finalUser))\n\n        // 可选：同步到你的后端数据库 (保留了你之前的逻辑)\n        try {\n          await fetch('/api/auth/sync', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              user_id: finalUser.id || finalUser.sub,\n              email: finalUser.email,\n              nickname: finalUser.nickname || finalUser.username,\n              avatar: finalUser.photo\n            })\n          })\n        } catch(e) {\n          console.error('同步失败', e)\n        }\n\n        // [关键] 登录后跳转回刚才的页面（比如支付页）\n        const redirectPath = searchParams.get('redirect')\n        \n        if (redirectPath) {\n          console.log('正在返回之前的页面:', redirectPath)\n          // 使用 decodeURIComponent 确保网址格式正确\n          router.replace(decodeURIComponent(redirectPath))\n        } else {\n          router.replace('/')\n        }\n      })\n\n      guard.start('#authing-guard-container')\n      guardRef.current = guard\n      setIsLoaded(true)\n    })\n  }, [appId, router, searchParams])\n\n  return (\n    <div style={{ \n      height: '100vh', \n      display: 'flex', \n      flexDirection: 'column', \n      justifyContent: 'center', \n      alignItems: 'center', \n      backgroundColor: '#f5f5f5' \n    }}>\n      {/* 登录框容器 */}\n      <div id=\"authing-guard-container\" style={{ minHeight: '500px' }}></div>\n      \n      {!isLoaded && (\n        <p style={{ color: '#666', marginTop: '20px' }}>\n          正在加载安全登录组件...\n        </p>\n      )}\n    </div>\n  )\n}\n\n// 必须使用 Suspense 包裹，否则在 Next.js 新版本中可能会报错\nexport default function LoginPage() {\n  return (\n    <Suspense fallback={<div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>加载中...</div>}>\n      <AuthingLoginComponent />\n    </Suspense>\n  )\n}"],"names":[],"mappings":";;;;;AAEA;AACA;;;AAHA;;;AAKA,SAAS;;IACP,MAAM,SAAS,IAAA,kJAAS;IACxB,MAAM,eAAe,IAAA,wJAAe;IAEpC,0BAA0B;IAC1B,MAAM,QAAQ;IACd,MAAM,WAAW,IAAA,uKAAM,EAAM;IAC7B,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAC;IAEzC,IAAA,0KAAS;2CAAC;YACR,cAAc;YACd,yBAAyB;YACzB,MAAM,OAAO,aAAa,OAAO,CAAC;YAClC,IAAI,MAAM;gBACR,MAAM,eAAe,aAAa,GAAG,CAAC;gBACtC,OAAO,OAAO,CAAC,gBAAgB;gBAC/B;YACF;YAEA,IAAI,SAAS,OAAO,EAAE;YAEtB,qBAAqB;YACrB,MAAM,OAAO,SAAS,aAAa,CAAC;YACpC,KAAK,GAAG,GAAG;YACX,KAAK,IAAI,GAAG;YACZ,SAAS,IAAI,CAAC,WAAW,CAAC;YAE1B,mBAAmB;YACnB,+HAAyB,IAAI;mDAAC,CAAC;oBAC7B,MAAM,QAAQ,OAAO,KAAK;oBAC1B,IAAI,SAAS,OAAO,EAAE;oBAEtB,MAAM,QAAQ,IAAI,MAAM;wBACtB;wBACA,MAAM;oBACR;oBAEA,cAAc;oBACd,MAAM,EAAE,CAAC;2DAAS,OAAO;4BACvB,QAAQ,GAAG,CAAC,SAAS;4BAErB,4BAA4B;4BAC5B,MAAM,YAAY,SAAS,IAAI,IAAI;4BACnC,aAAa,OAAO,CAAC,eAAe,KAAK,SAAS,CAAC;4BAEnD,4BAA4B;4BAC5B,IAAI;gCACF,MAAM,MAAM,kBAAkB;oCAC5B,QAAQ;oCACR,SAAS;wCAAE,gBAAgB;oCAAmB;oCAC9C,MAAM,KAAK,SAAS,CAAC;wCACnB,SAAS,UAAU,EAAE,IAAI,UAAU,GAAG;wCACtC,OAAO,UAAU,KAAK;wCACtB,UAAU,UAAU,QAAQ,IAAI,UAAU,QAAQ;wCAClD,QAAQ,UAAU,KAAK;oCACzB;gCACF;4BACF,EAAE,OAAM,GAAG;gCACT,QAAQ,KAAK,CAAC,QAAQ;4BACxB;4BAEA,0BAA0B;4BAC1B,MAAM,eAAe,aAAa,GAAG,CAAC;4BAEtC,IAAI,cAAc;gCAChB,QAAQ,GAAG,CAAC,cAAc;gCAC1B,iCAAiC;gCACjC,OAAO,OAAO,CAAC,mBAAmB;4BACpC,OAAO;gCACL,OAAO,OAAO,CAAC;4BACjB;wBACF;;oBAEA,MAAM,KAAK,CAAC;oBACZ,SAAS,OAAO,GAAG;oBACnB,YAAY;gBACd;;QACF;0CAAG;QAAC;QAAO;QAAQ;KAAa;IAEhC,qBACE,6LAAC;QAAI,OAAO;YACV,QAAQ;YACR,SAAS;YACT,eAAe;YACf,gBAAgB;YAChB,YAAY;YACZ,iBAAiB;QACnB;;0BAEE,6LAAC;gBAAI,IAAG;gBAA0B,OAAO;oBAAE,WAAW;gBAAQ;;;;;;YAE7D,CAAC,0BACA,6LAAC;gBAAE,OAAO;oBAAE,OAAO;oBAAQ,WAAW;gBAAO;0BAAG;;;;;;;;;;;;AAMxD;GAlGS;;QACQ,kJAAS;QACH,wJAAe;;;KAF7B;AAqGM,SAAS;IACtB,qBACE,6LAAC,yKAAQ;QAAC,wBAAU,6LAAC;YAAI,OAAO;gBAAE,QAAQ;gBAAS,SAAS;gBAAQ,gBAAgB;gBAAU,YAAY;YAAS;sBAAG;;;;;;kBACpH,cAAA,6LAAC;;;;;;;;;;AAGP;MANwB","debugId":null}}]
}