{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/login/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useEffect, useRef, useState, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\n\nfunction AuthingLoginComponent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  \n  // 从环境变量读取 Authing App ID\n  const appId = process.env.NEXT_PUBLIC_AUTHING_APP_ID || ''\n  const guardRef = useRef<any>(null)\n  const [isLoaded, setIsLoaded] = useState(false)\n\n  useEffect(() => {\n    // 1. 检查是否已经登录\n    // 如果已经有用户信息，直接跳转，不再显示登录框\n    const user = localStorage.getItem('currentUser')\n    if (user) {\n      const redirectPath = searchParams.get('redirect')\n      router.replace(redirectPath || '/')\n      return\n    }\n\n    if (guardRef.current) return\n\n    // 2. 动态加载 Authing 样式\n    const link = document.createElement('link')\n    link.rel = 'stylesheet'\n    link.href = 'https://cdn.authing.co/packages/guard/latest/guard.min.css'\n    document.head.appendChild(link)\n\n    // 3. 加载 Authing 组件\n    import('@authing/guard').then((module) => {\n      const Guard = module.Guard\n      if (guardRef.current) return\n\n      try {\n        const guard = new Guard({\n          appId,\n          mode: 'normal', // 使用普通模式，不强制跳转\n        })\n\n      // ✅ 登录成功的处理逻辑\n      guard.on('login', async (userInfo: any) => {\n        console.log('登录成功:', userInfo)\n        \n        // [关键] 保存用户信息到浏览器，以便支付页面能看到\n        const finalUser = userInfo.data || userInfo\n        localStorage.setItem('currentUser', JSON.stringify(finalUser))\n\n        // 可选：同步到你的后端数据库 (保留了你之前的逻辑)\n        try {\n          await fetch('/api/auth/sync', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              user_id: finalUser.id || finalUser.sub,\n              email: finalUser.email,\n              nickname: finalUser.nickname || finalUser.username,\n              avatar: finalUser.photo,\n              // ✨ [新增] 同步手机号\n              // Authing 返回的手机号字段可能是 phone 或 phone_number\n              phone: finalUser.phone || finalUser.phone_number \n            })\n          })\n        } catch(e) {\n          console.error('同步失败', e)\n        }\n\n        // [关键] 登录后跳转回刚才的页面（比如支付页）\n        const redirectPath = searchParams.get('redirect')\n        \n        if (redirectPath) {\n          console.log('正在返回之前的页面:', redirectPath)\n          // 使用 decodeURIComponent 确保网址格式正确\n          router.replace(decodeURIComponent(redirectPath))\n        } else {\n          router.replace('/')\n        }\n      })\n\n        guard.start('#authing-guard-container')\n        guardRef.current = guard\n        setIsLoaded(true)\n      } catch (error) {\n        console.error('Authing Guard 初始化失败:', error)\n        setIsLoaded(true) // 即使失败也标记为已加载，避免无限等待\n      }\n    }).catch((error) => {\n      console.error('加载 Authing 模块失败:', error)\n      setIsLoaded(true)\n    })\n  }, [appId, router, searchParams])\n\n  return (\n    <div style={{ \n      height: '100vh', \n      display: 'flex', \n      flexDirection: 'column', \n      justifyContent: 'center', \n      alignItems: 'center', \n      backgroundColor: '#f5f5f5' \n    }}>\n      {/* 登录框容器 */}\n      <div id=\"authing-guard-container\" style={{ minHeight: '500px' }}></div>\n      \n      {!isLoaded && (\n        <p style={{ color: '#666', marginTop: '20px' }}>\n          正在加载安全登录组件...\n        </p>\n      )}\n    </div>\n  )\n}\n\n// 必须使用 Suspense 包裹，否则在 Next.js 新版本中可能会报错\nexport default function LoginPage() {\n  return (\n    <Suspense fallback={<div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>加载中...</div>}>\n      <AuthingLoginComponent />\n    </Suspense>\n  )\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}