{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/components/ui/label.tsx"],"sourcesContent":["'use client'\n\nimport * as React from 'react'\nimport * as LabelPrimitive from '@radix-ui/react-label'\n\nimport { cn } from '@/lib/utils'\n\nfunction Label({\n  className,\n  ...props\n}: React.ComponentProps<typeof LabelPrimitive.Root>) {\n  return (\n    <LabelPrimitive.Root\n      data-slot=\"label\"\n      className={cn(\n        'flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50',\n        className,\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Label }\n"],"names":[],"mappings":";;;;;AAGA;AAEA;AALA;;;;AAOA,SAAS,MAAM,EACb,SAAS,EACT,GAAG,OAC8C;IACjD,qBACE,oWAAC,kZAAmB;QAClB,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,uNACA;QAED,GAAG,KAAK;;;;;;AAGf;KAdS","debugId":null}},
    {"offset": {"line": 37, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/settings/page.tsx"],"sourcesContent":["\"use client\"\n\nimport { useState, useEffect, useRef } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { createClient } from \"@supabase/supabase-js\"\nimport { toast } from \"sonner\"\nimport { Loader2, Upload, Camera, AlertCircle } from \"lucide-react\"\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n)\n\nexport default function SettingsPage() {\n  const [user, setUser] = useState<any>(null)\n  const [loading, setLoading] = useState(false)\n  const [uploading, setUploading] = useState(false)\n  \n  const [displayName, setDisplayName] = useState(\"\")\n  const [avatarUrl, setAvatarUrl] = useState(\"\")\n  const [debugError, setDebugError] = useState<string | null>(null)\n  \n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  useEffect(() => {\n    // 优先从本地读取，确保能拿到 ID (即使是手机号)\n    const initUser = () => {\n      if (typeof window !== 'undefined') {\n        const localStr = localStorage.getItem('currentUser')\n        if (localStr) {\n          try {\n            const localUser = JSON.parse(localStr)\n            setUser(localUser)\n            // 初始化表单数据\n            setDisplayName(localUser.user_metadata?.name || \"\")\n            setAvatarUrl(localUser.user_metadata?.avatar_url || \"\")\n          } catch (e) {}\n        }\n      }\n    }\n    initUser()\n  }, [])\n\n  const handleUploadAvatar = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    setDebugError(null) \n    try {\n      setUploading(true)\n      \n      if (!event.target.files || event.target.files.length === 0) return\n\n      const file = event.target.files[0]\n      // 简单的文件名生成\n      const fileExt = file.name.split('.').pop()\n      const fileName = `avatar_${Date.now()}.${fileExt}`\n\n      console.log(\"正在上传:\", fileName)\n\n      // 1. 上传 (依赖我们之前开启的万能权限)\n      const { data, error: uploadError } = await supabase.storage\n        .from('avatars')\n        .upload(fileName, file, {\n          cacheControl: '3600',\n          upsert: true\n        })\n\n      if (uploadError) {\n        const err = uploadError as any\n        throw new Error(`Upload Error: ${err.message}`)\n      }\n\n      // 2. 获取链接\n      const { data: { publicUrl } } = supabase.storage\n        .from('avatars')\n        .getPublicUrl(fileName)\n\n      // 加时间戳防缓存\n      const finalUrl = `${publicUrl}?t=${Date.now()}`\n      \n      console.log(\"头像链接:\", finalUrl)\n      setAvatarUrl(finalUrl)\n      toast.success(\"上传成功！请点击【保存修改】\")\n\n    } catch (error: any) {\n      console.error(error)\n      setDebugError(error.message || \"未知错误\")\n      toast.error(\"上传失败，请看下方红字\")\n    } finally {\n      setUploading(false)\n    }\n  }\n\n  const handleSave = async () => {\n    setDebugError(null)\n    setLoading(true)\n\n    try {\n      // 1. 获取 ID (可能是手机号，也可能是 UUID)\n      const userId = user.id || user.sub || user.userId\n      \n      // 2. 呼叫后端 API 强制更新 (核心修改：不走前端 SDK 了)\n      const response = await fetch('/api/user/update', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          userId: userId,\n          name: displayName,\n          avatarUrl: avatarUrl\n        })\n      })\n\n      const result = await response.json()\n      if (!response.ok) {\n        throw new Error(result.error || \"更新失败\")\n      }\n\n      // 3. 更新本地缓存 (确保侧边栏同步)\n      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}')\n      const updatedUser = {\n        ...currentUser,\n        user_metadata: {\n          ...currentUser.user_metadata,\n          name: displayName,\n          avatar_url: avatarUrl\n        }\n      }\n      localStorage.setItem('currentUser', JSON.stringify(updatedUser))\n\n      toast.success(\"保存成功！\")\n      \n      // 4. 刷新页面\n      setTimeout(() => {\n        window.location.reload()\n      }, 800)\n      \n    } catch (error: any) {\n      console.error(error)\n      setDebugError(`Save Error: ${error.message}`)\n      toast.error(\"保存失败\")\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"flex-1 p-8 bg-[#F9FAFB] min-h-screen\">\n      <div className=\"max-w-2xl mx-auto space-y-8\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-gray-900\">账号设置</h2>\n          <p className=\"text-gray-500 mt-1\">设置您的头像和昵称。</p>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden\">\n          <div className=\"p-6 space-y-8\">\n            \n            {/* 头像 */}\n            <div className=\"space-y-4\">\n              <Label className=\"text-base\">个人头像</Label>\n              <div className=\"flex items-center gap-6 pb-6 border-b border-gray-100\">\n                <div className=\"relative group cursor-pointer\" onClick={() => fileInputRef.current?.click()}>\n                  <div className=\"h-24 w-24 rounded-full overflow-hidden border-4 border-gray-50 shadow-sm bg-gray-100 flex items-center justify-center\">\n                    {avatarUrl ? (\n                      <img src={avatarUrl} alt=\"Avatar\" className=\"h-full w-full object-cover\" />\n                    ) : (\n                      <span className=\"text-3xl font-bold text-gray-300\">\n                        {displayName?.[0]?.toUpperCase() || \"U\"}\n                      </span>\n                    )}\n                  </div>\n                  <div className=\"absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\">\n                    <Camera className=\"h-8 w-8 text-white\" />\n                  </div>\n                  {uploading && (\n                    <div className=\"absolute inset-0 bg-white/80 rounded-full flex items-center justify-center opacity-100\">\n                      <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n                    </div>\n                  )}\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <h3 className=\"font-medium text-gray-900\">点击左侧圆形上传</h3>\n                  <p className=\"text-sm text-gray-500\">支持 JPG, PNG, GIF</p>\n                  <input type=\"file\" ref={fileInputRef} className=\"hidden\" accept=\"image/*\" onChange={handleUploadAvatar} />\n                  <Button variant=\"outline\" size=\"sm\" onClick={() => fileInputRef.current?.click()} disabled={uploading}>\n                    <Upload className=\"h-4 w-4 mr-2\" />\n                    {uploading ? \"上传中...\" : \"选择图片\"}\n                  </Button>\n                </div>\n              </div>\n            </div>\n\n            {/* 调试信息 */}\n            {debugError && (\n              <div className=\"rounded-lg bg-red-50 p-4 border border-red-200 flex items-start gap-3\">\n                <AlertCircle className=\"h-5 w-5 text-red-600 mt-0.5\" />\n                <div className=\"text-sm text-red-800 break-all font-mono\">{debugError}</div>\n              </div>\n            )}\n\n            {/* 昵称 */}\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>账号</Label>\n                <Input value={user?.email || user?.phone || \"\"} disabled className=\"bg-gray-50 text-gray-500\" />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>昵称</Label>\n                <Input value={displayName} onChange={(e) => setDisplayName(e.target.value)} placeholder=\"请输入您的昵称\" />\n              </div>\n            </div>\n\n            <div className=\"pt-4\">\n              <Button onClick={handleSave} disabled={loading} className=\"w-full sm:w-auto bg-[#0F766E] hover:bg-[#0d655d]\">\n                {loading ? <Loader2 className=\"h-4 w-4 animate-spin mr-2\" /> : null}\n                保存修改\n              </Button>\n            </div>\n\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}"],"names":[],"mappings":"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","debugId":null}}]
}