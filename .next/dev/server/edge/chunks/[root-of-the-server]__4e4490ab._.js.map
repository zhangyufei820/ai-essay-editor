{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/supabase/middleware.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { NextResponse, type NextRequest } from \"next/server\"\n\n// éœ€è¦èº«ä»½éªŒè¯çš„ API è·¯ç”±å‰ç¼€\nconst PROTECTED_API_ROUTES = [\n  \"/api/dify-chat\",\n  \"/api/dify-upload\",\n  \"/api/chat-session\",\n  \"/api/save-message\",\n  \"/api/save-essay-review\",\n  \"/api/user/update\",\n]\n\n// å…¬å¼€çš„ API è·¯ç”±ï¼ˆä¸éœ€è¦éªŒè¯ï¼‰\nconst PUBLIC_API_ROUTES = [\n  \"/api/auth/\",           // è®¤è¯ç›¸å…³æ¥å£\n  \"/api/payment/xunhupay/notify\", // æ”¯ä»˜å›è°ƒ\n  \"/api/providers\",       // å…¬å¼€çš„é…ç½®æ¥å£\n]\n\nexport async function updateSession(request: NextRequest) {\n  const url = request.nextUrl\n  const pathname = url.pathname\n  const code = url.searchParams.get(\"code\")\n\n  // å¤„ç† OAuth å›è°ƒ\n  if (code && !pathname.startsWith(\"/auth/callback\")) {\n    const callbackUrl = url.clone()\n    callbackUrl.pathname = \"/auth/callback\"\n    return NextResponse.redirect(callbackUrl)\n  }\n\n  let supabaseResponse = NextResponse.next({\n    request,\n  })\n\n  const supabase = createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll()\n        },\n        setAll(cookiesToSet) {\n          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))\n          supabaseResponse = NextResponse.next({\n            request,\n          })\n          cookiesToSet.forEach(({ name, value, options }) => supabaseResponse.cookies.set(name, value, options))\n        },\n      },\n    },\n  )\n\n  // ========================================\n  // ğŸ” API è·¯ç”±èº«ä»½éªŒè¯æ£€æŸ¥\n  // ========================================\n  \n  // æ£€æŸ¥æ˜¯å¦æ˜¯å…¬å¼€è·¯ç”±\n  const isPublicRoute = PUBLIC_API_ROUTES.some(route => pathname.startsWith(route))\n  if (isPublicRoute) {\n    return supabaseResponse\n  }\n\n  // æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦ä¿æŠ¤çš„ API è·¯ç”±\n  const isProtectedApiRoute = PROTECTED_API_ROUTES.some(route => pathname.startsWith(route))\n  \n  if (isProtectedApiRoute) {\n    // æ–¹å¼1: æ£€æŸ¥ Supabase Session\n    const { data: { user } } = await supabase.auth.getUser()\n    \n    // æ–¹å¼2: æ£€æŸ¥ Authorization Header (ç”¨äºå‰ç«¯ä¼ é€’çš„ userId)\n    const authHeader = request.headers.get(\"Authorization\")\n    const userId = request.headers.get(\"X-User-Id\")\n    \n    // å¦‚æœæ—¢æ²¡æœ‰ Supabase ç”¨æˆ·ï¼Œä¹Ÿæ²¡æœ‰æœ‰æ•ˆçš„ userId headerï¼Œåˆ™æ‹’ç»è®¿é—®\n    if (!user && !userId) {\n      console.warn(`ğŸš« [Middleware] æœªæˆæƒè®¿é—®è¢«æ‹¦æˆª: ${pathname}`)\n      return NextResponse.json(\n        { error: \"æœªæˆæƒè®¿é—®ï¼Œè¯·å…ˆç™»å½•\", code: \"UNAUTHORIZED\" },\n        { status: 401 }\n      )\n    }\n    \n    // è®°å½•è®¿é—®æ—¥å¿—\n    console.log(`âœ… [Middleware] å·²æˆæƒè®¿é—®: ${pathname} | User: ${user?.id || userId}`)\n  }\n\n  return supabaseResponse\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AAAA;;;AAEA,mBAAmB;AACnB,MAAM,uBAAuB;IAC3B;IACA;IACA;IACA;IACA;IACA;CACD;AAED,oBAAoB;AACpB,MAAM,oBAAoB;IACxB;IACA;IACA;CACD;AAEM,eAAe,cAAc,OAAoB;IACtD,MAAM,MAAM,QAAQ,OAAO;IAC3B,MAAM,WAAW,IAAI,QAAQ;IAC7B,MAAM,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC;IAElC,cAAc;IACd,IAAI,QAAQ,CAAC,SAAS,UAAU,CAAC,mBAAmB;QAClD,MAAM,cAAc,IAAI,KAAK;QAC7B,YAAY,QAAQ,GAAG;QACvB,OAAO,yYAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI,mBAAmB,yYAAY,CAAC,IAAI,CAAC;QACvC;IACF;IAEA,MAAM,WAAW,IAAA,oTAAkB,oKAGjC;QACE,SAAS;YACP;gBACE,OAAO,QAAQ,OAAO,CAAC,MAAM;YAC/B;YACA,QAAO,YAAY;gBACjB,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,GAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,MAAM;gBACpE,mBAAmB,yYAAY,CAAC,IAAI,CAAC;oBACnC;gBACF;gBACA,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,iBAAiB,OAAO,CAAC,GAAG,CAAC,MAAM,OAAO;YAC/F;QACF;IACF;IAGF,2CAA2C;IAC3C,kBAAkB;IAClB,2CAA2C;IAE3C,YAAY;IACZ,MAAM,gBAAgB,kBAAkB,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;IAC1E,IAAI,eAAe;QACjB,OAAO;IACT;IAEA,oBAAoB;IACpB,MAAM,sBAAsB,qBAAqB,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;IAEnF,IAAI,qBAAqB;QACvB,2BAA2B;QAC3B,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAEtD,gDAAgD;QAChD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;QACvC,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;QAEnC,+CAA+C;QAC/C,IAAI,CAAC,QAAQ,CAAC,QAAQ;YACpB,QAAQ,IAAI,CAAC,CAAC,0BAA0B,EAAE,UAAU;YACpD,OAAO,yYAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAc,MAAM;YAAe,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,SAAS;QACT,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,SAAS,SAAS,EAAE,MAAM,MAAM,QAAQ;IAC/E;IAEA,OAAO;AACT"}},
    {"offset": {"line": 103, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { updateSession } from \"@/lib/supabase/middleware\"\nimport type { NextRequest } from \"next/server\"\n\nexport async function middleware(request: NextRequest) {\n  return await updateSession(request)\n}\n\nexport const config = {\n  matcher: [\"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\"],\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAGO,eAAe,WAAW,OAAoB;IACnD,OAAO,MAAM,IAAA,sJAAa,EAAC;AAC7B;AAEO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAoF;AAChG"}}]
}