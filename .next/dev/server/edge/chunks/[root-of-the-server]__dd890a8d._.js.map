{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/api/dify-chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { createClient } from \"@supabase/supabase-js\"\n\nexport const runtime = \"edge\"\nexport const maxDuration = 60\n\n// 默认的基础配置\nconst DIFY_BASE_URL = process.env.DIFY_BASE_URL || \"https://api.dify.ai/v1\"\nconst DEFAULT_DIFY_KEY = process.env.DIFY_API_KEY \n\n// 🚨 关键修改 1：暂时将费用设为 0，防止报 402 错误\nconst COST_ESSAY = 250 \nconst COST_CHAT = 20  \n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { query, conversation_id, fileIds, userId, inputs, model } = body\n\n    console.log(`🔄 [切换模型] 用户: ${userId || \"访客\"} | 目标模型: ${model || \"默认标准版\"}`)\n\n    // --- 1. 钥匙分发中心 (彻底分离通道) ---\n    let targetApiKey = DEFAULT_DIFY_KEY; // 默认给标准版\n\n    // 根据前端传来的暗号，分发不同的钥匙\n    switch (model) {\n        case \"gpt-5\":\n            targetApiKey = process.env.DIFY_API_KEY_GPT5;\n            break;\n        case \"claude-opus\":\n            targetApiKey = process.env.DIFY_API_KEY_CLAUDE;\n            break;\n        case \"gemini-pro\":\n            targetApiKey = process.env.DIFY_API_KEY_GEMINI;\n            break;\n        // 如果是 Banana/Sono/Sora 可以在这里继续加 case\n        default:\n            // 如果没传 model 或者 model 是 standard，就用上面的默认 Key\n            break;\n    }\n\n    // 安全检查：防止忘配 Key\n    if (!targetApiKey) {\n        console.error(`❌ 严重错误: 模型 ${model} 的 API Key 未配置！`);\n        return new Response(JSON.stringify({ error: `Server Error: Key for ${model} missing` }), { status: 500 });\n    }\n\n    // --- 2. 计费模块 (目前已设为免费，畅通无阻) ---\n    // 为了防止逻辑干扰，这里只保留最基础的检查，不再拦截\n    if (userId) {\n       // 这里原本是扣费逻辑，现在 COST 是 0，所以会直接通过\n       // console.log(\"本轮免费测试，不扣积分\");\n    }\n\n    // --- 3. 构造 Dify 请求函数 ---\n    // 封装成函数，方便出错时重试\n    const callDify = async (retryWithoutId = false) => {\n        \n        // 如果是重试模式，或者是切换模型后的第一次请求，为了安全，我们可以强制新开会话\n        // 但为了保留上下文，我们先尝试带 ID，如果报错再重试\n        const currentConvId = retryWithoutId ? null : conversation_id;\n\n        const difyRequest: any = {\n            inputs: inputs || {},\n            query: query || \"你好\",\n            response_mode: \"streaming\",\n            user: userId || \"default-user\",\n            conversation_id: currentConvId,\n        }\n\n        if (fileIds && fileIds.length > 0) {\n            difyRequest.files = fileIds.map((id: string) => ({\n                type: 'image',\n                transfer_method: 'local_file',\n                upload_file_id: id\n            }));\n        }\n\n        const response = await fetch(`${DIFY_BASE_URL}/chat-messages`, {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n                // ⚠️ 使用刚才选好的特定钥匙\n                Authorization: `Bearer ${targetApiKey}`, \n            },\n            body: JSON.stringify(difyRequest),\n        })\n\n        return response;\n    };\n\n    // --- 4. 执行请求与智能容错 ---\n    let response = await callDify(false);\n\n    // 🚨 关键修改 2：智能处理会话冲突\n    // 如果 Dify 返回 404 (Conversation Not Found) 或 400 (Parameters Error 往往是因为 ID 不属于该 App)\n    // 说明前端传来的 conversation_id 是旧模型的，新模型不认识。\n    // 这时候我们自动丢弃 ID，重新发起一次“新会话”请求。\n    if (response.status === 404 || response.status === 400) {\n        console.warn(`⚠️ 会话 ID 冲突 (可能切换了模型)，自动开启新会话重试...`);\n        response = await callDify(true); // 传入 true，强制清除 ID 重试\n    }\n\n    // 如果还是错，那就真报错了\n    if (!response.ok) {\n        const errorText = await response.text()\n        console.error(`❌ Dify API 最终报错 (${model}):`, errorText)\n        return new Response(JSON.stringify({ error: `Dify Error: ${errorText}` }), { status: response.status })\n    }\n\n    // 成功连接，建立流式管道\n    return new Response(response.body, {\n        headers: { \"Content-Type\": \"text/event-stream\" },\n    })\n\n  } catch (error: any) {\n    console.error(\"❌ 后端致命错误:\", error);\n    return new Response(JSON.stringify({ error: error.message }), { status: 500 })\n  }\n}"],"names":[],"mappings":"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"}}]
}