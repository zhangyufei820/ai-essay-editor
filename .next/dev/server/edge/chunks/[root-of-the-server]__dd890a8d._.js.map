{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/api/dify-chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { createClient } from \"@supabase/supabase-js\"\n\nexport const runtime = \"edge\"\nexport const maxDuration = 60\n\nconst DIFY_BASE_URL = process.env.DIFY_BASE_URL || \"https://api.dify.ai/v1\"\nconst DIFY_API_KEY = process.env.DIFY_API_KEY\nconst COST_ESSAY = 250 \nconst COST_CHAT = 20   \n\nexport async function POST(request: NextRequest) {\n  if (!DIFY_API_KEY) {\n    return new Response(JSON.stringify({ error: \"Dify API key not configured\" }), { status: 500 })\n  }\n\n  try {\n    const body = await request.json()\n    const { query, conversation_id, fileIds, userId, inputs } = body\n\n    console.log(`üë§ [User: ${userId}] ËØ∑Ê±Ç Dify...`)\n\n    // 1. ËÆ°Ë¥πÈÄªËæë (Áï•Ôºå‰øùÊåÅ‰πãÂâç‰∏ÄËá¥)\n    const hasFiles = fileIds && fileIds.length > 0\n    const isLongText = query && query.length > 150\n    const isHeavyTask = hasFiles || isLongText\n    const currentCost = isHeavyTask ? COST_ESSAY : COST_CHAT\n\n    if (userId) {\n      try {\n        const supabase = createClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL!,\n          process.env.SUPABASE_SERVICE_ROLE_KEY!\n        )\n        const { data: userData } = await supabase.from('user_credits').select('credits').eq('user_id', userId).single()\n        \n        if (userData) {\n          if (userData.credits < currentCost) {\n            return new Response(JSON.stringify({ error: `ÁßØÂàÜ‰∏çË∂≥ÔºÅÈúÄË¶Å ${currentCost}ÔºåÂâ©‰Ωô ${userData.credits}` }), { status: 402 })\n          }\n          await supabase.from('user_credits').update({ credits: userData.credits - currentCost }).eq('user_id', userId)\n          console.log(`üí∞ Êâ£Ë¥πÊàêÂäü: -${currentCost}`)\n        }\n      } catch (e) { console.error(\"Êâ£Ë¥πÊ®°ÂùóÈîôËØØ:\", e) }\n    }\n\n    // 2. üõ°Ô∏è ID Ê†ºÂºèÊ∏ÖÊ¥ó (Èò≤Ê≠¢ 400 ÈîôËØØ)\n    // Dify ÁöÑ conversation_id ÂøÖÈ°ªÊòØ UUID Ê†ºÂºè\n    // Â¶ÇÊûúÂâçÁ´Ø‰º†‰∫ÜÊó∂Èó¥Êà≥(Á∫ØÊï∞Â≠ó)ÊàñËÄÖÊó†ÊïàÂ≠óÁ¨¶‰∏≤ÔºåÊàë‰ª¨Âº∫Âà∂ÁΩÆ‰∏∫ null\n    let validConversationId = conversation_id;\n    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n    \n    if (conversation_id && !uuidRegex.test(conversation_id)) {\n        console.warn(\"‚ö†Ô∏è Ê£ÄÊµãÂà∞Êó†ÊïàÁöÑ conversation_id (ÂèØËÉΩÊòØÊú¨Âú∞‰∏¥Êó∂ID)ÔºåÂ∑≤Ëá™Âä®ÂøΩÁï•:\", conversation_id);\n        validConversationId = null;\n    }\n\n    // 3. ÊûÑÈÄ†ËØ∑Ê±Ç\n    const difyRequest: any = {\n      inputs: inputs || {},\n      query: query || \"ËØ∑Â∏ÆÊàëÊâπÊîπËøôÁØá‰ΩúÊñá\",\n      response_mode: \"streaming\",\n      user: userId || \"default-user\",\n      conversation_id: validConversationId, // ‰ΩøÁî®Ê∏ÖÊ¥óÂêéÁöÑ ID\n    }\n\n    if (hasFiles) {\n      difyRequest.files = fileIds.map((id: string) => ({\n        type: 'image',\n        transfer_method: 'local_file',\n        upload_file_id: id\n      }));\n    }\n\n    // 4. Ë∞ÉÁî®\n    const response = await fetch(`${DIFY_BASE_URL}/chat-messages`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${DIFY_API_KEY}`,\n      },\n      body: JSON.stringify(difyRequest),\n    })\n\n    if (!response.ok) {\n      const errorText = await response.text()\n      console.error(\"‚ùå Dify ËøîÂõûÈîôËØØ:\", errorText)\n      // ËøîÂõûËØ¶ÁªÜÈîôËØØÁªôÂâçÁ´ØÔºåÊñπ‰æøË∞ÉËØï\n      return new Response(JSON.stringify({ error: `Dify Error (${response.status}): ${errorText}` }), { status: response.status })\n    }\n\n    return new Response(response.body, {\n      headers: { \"Content-Type\": \"text/event-stream\" },\n    })\n\n  } catch (error: any) {\n    return new Response(JSON.stringify({ error: error.message }), { status: 500 })\n  }\n}"],"names":[],"mappings":"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"}}]
}