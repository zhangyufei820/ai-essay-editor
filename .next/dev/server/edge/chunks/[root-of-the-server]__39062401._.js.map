{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/api/user/update/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\nimport { NextRequest, NextResponse } from 'next/server'\n\nexport const runtime = 'edge'\n\n// ‰ΩøÁî® Service Role Key (Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊùÉÈôê)\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n)\n\nfunction isUUID(str: string) {\n  const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n  return regex.test(str);\n}\n\n// Êö¥ÂäõÊèêÂèñÁ∫ØÊï∞Â≠ó (Êää +86, -, Á©∫Ê†ºÂÖ®ÈÉ®Âπ≤Êéâ)\nfunction getPureNumbers(str: any) {\n  if (!str) return \"\"\n  return String(str).replace(/\\D/g, '') \n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    let { userId, name, avatarUrl } = await req.json()\n\n    if (!userId) {\n      return NextResponse.json({ error: \"Áº∫Â∞ë User ID\" }, { status: 400 })\n    }\n\n    console.log(`[Admin Update] Ê≠£Âú®ÂØªÊâæÁî®Êà∑: ${userId}`)\n\n    // 1. Â¶ÇÊûú‰º†ËøõÊù•ÁöÑÊòØ UUIDÔºåÁõ¥Êé•Êõ¥Êñ∞\n    if (isUUID(userId)) {\n        // Áõ¥Êé•Ëµ∞Êõ¥Êñ∞ÊµÅÁ®ã...\n    } \n    // 2. Â¶ÇÊûú‰∏çÊòØ UUIDÔºåÂºÄÂêØ„ÄêÂÖ®ÁΩëÈÄöÁºâ„ÄëÊ®°Âºè\n    else {\n      const searchTarget = getPureNumbers(userId) // ÁõÆÊ†áÂè∑Á†ÅÁ∫ØÊï∞Â≠óÔºö15881822773\n      \n      console.log(`[Admin Update] ÂêØÂä®Ê®°Á≥äÊêúÁ¥¢ÔºåÁõÆÊ†áÁâπÂæÅÁ†Å: ${searchTarget}`)\n      \n      // Ëé∑ÂèñÂâç 1000 ‰∏™Áî®Êà∑\n      const { data: { users }, error: listError } = await supabaseAdmin.auth.admin.listUsers({\n        perPage: 1000 \n      })\n      \n      if (listError) throw listError\n\n      // üïµÔ∏è‚Äç‚ôÇÔ∏è Ê∑±Â∫¶ÊØîÂØπ\n      const targetUser = users.find(u => {\n        // A. Ê£ÄÊü•Ê†áÂáÜÊâãÊú∫Âè∑Â≠óÊÆµ\n        const dbPhone = getPureNumbers(u.phone)\n        // B. Ê£ÄÊü•ÈÇÆÁÆ±Â≠óÊÆµ (Êúâ‰∫õ‰∫∫Áî®ÊâãÊú∫Âè∑ÂΩìÈÇÆÁÆ±Ê≥®ÂÜå)\n        const dbEmail = getPureNumbers(u.email)\n        // C. Ê£ÄÊü•ÂÖÉÊï∞ÊçÆÈáåÁöÑÂ≠óÊÆµ\n        const metaPhone = getPureNumbers(u.user_metadata?.phone || u.user_metadata?.mobile || \"\")\n\n        // ÊØîÂØπÈÄªËæëÔºöÂè™Ë¶Å‰ªª‰Ωï‰∏Ä‰∏™Â≠óÊÆµÂåÖÂê´‰∫ÜÁõÆÊ†áÂè∑Á†ÅÔºàÊàñËÄÖË¢´ÂåÖÂê´ÔºâÔºåÂ∞±ËÆ§‰∏∫ÊòØËøô‰∏™‰∫∫\n        if (dbPhone.includes(searchTarget) || searchTarget.includes(dbPhone)) return true\n        if (dbEmail.includes(searchTarget) || searchTarget.includes(dbEmail)) return true\n        if (metaPhone.includes(searchTarget)) return true\n        \n        return false\n      })\n\n      if (targetUser) {\n        console.log(`[Admin Update] ‚úÖ ÊâæÂà∞ÁõÆÊ†á! ÁúüÂÆûID: ${targetUser.id}, ÊâãÊú∫: ${targetUser.phone}`)\n        userId = targetUser.id // ÊõøÊç¢‰∏∫ÁúüÂÆûÁöÑ UUID\n      } else {\n        // üõë Ë∞ÉËØï‰ø°ÊÅØÔºöÂ¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÊâìÂç∞Ââç3‰∏™Áî®Êà∑ÁúãÁúãÈïø‰ªÄ‰πàÊ†∑ÔºåÊñπ‰æøÊéíÊü•\n        console.error(`[Admin Update] ‚ùå ÈÅçÂéÜ‰∫Ü ${users.length} ‰∏™Áî®Êà∑‰ªçÊú™ÊâæÂà∞„ÄÇ`)\n        if (users.length > 0) {\n            console.log(\"Êï∞ÊçÆÂ∫ìÈáåÁöÑÁî®Êà∑Ê†∑Êú¨:\", users.slice(0, 3).map(u => ({ id: u.id, phone: u.phone, email: u.email })))\n        }\n        \n        return NextResponse.json({ \n            error: `ÂêéÁ´ØÊú™ÊâæÂà∞Ë¥¶Âè∑ ${userId}„ÄÇÂèØËÉΩÊòØÊï∞ÊçÆÂ∫ì‰∏≠Â≠òÂÇ®ÁöÑÊ†ºÂºèÂ∑ÆÂºÇÔºåËØ∑Êü•ÁúãÂêéÁ´ØÊó•Âøó„ÄÇ` \n        }, { status: 404 })\n      }\n    }\n\n    // 3. ÊâßË°åÂº∫Âà∂Êõ¥Êñ∞\n    const { data, error } = await supabaseAdmin.auth.admin.updateUserById(\n      userId,\n      {\n        user_metadata: {\n          name: name,\n          avatar_url: avatarUrl\n        }\n      }\n    )\n\n    if (error) {\n      console.error(\"Supabase Êõ¥Êñ∞Â§±Ë¥•:\", error)\n      return NextResponse.json({ error: error.message }, { status: 500 })\n    }\n\n    console.log(`[Admin Update] Êõ¥Êñ∞ÊàêÂäü!`)\n    return NextResponse.json({ success: true, user: data.user })\n\n  } catch (error: any) {\n    console.error(\"API ÂÜÖÈÉ®ÈîôËØØ:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}"],"names":[],"mappings":"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"}}]
}