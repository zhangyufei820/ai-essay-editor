{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/auth/sync/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\nimport { NextResponse } from 'next/server'\n\nexport async function POST(request: Request) {\n  try {\n    // 1. 获取前端传来的用户信息\n    const body = await request.json()\n    const { user_id, email, nickname, avatar, phone } = body\n\n    if (!user_id) {\n      return NextResponse.json({ error: 'Missing user_id' }, { status: 400 })\n    }\n\n    // 🔐 安全验证：检查请求来源\n    // 方式1: 检查 Referer 头，确保请求来自本站\n    const referer = request.headers.get('referer') || ''\n    const origin = request.headers.get('origin') || ''\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'\n    \n    const isValidOrigin = referer.startsWith(appUrl) || \n                          origin.startsWith(appUrl) ||\n                          referer.includes('localhost') ||\n                          origin.includes('localhost')\n    \n    if (!isValidOrigin) {\n      console.warn(`🚫 [Auth/Sync] 可疑请求来源被拦截: referer=${referer}, origin=${origin}`)\n      return NextResponse.json({ error: 'Invalid request origin' }, { status: 403 })\n    }\n\n    // 方式2: 基本的 user_id 格式验证（防止注入攻击）\n    // Authing 的 user_id 通常是 24 位十六进制字符串\n    const isValidUserId = /^[a-f0-9]{24}$/.test(user_id) || \n                          /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(user_id)\n    \n    if (!isValidUserId) {\n      console.warn(`🚫 [Auth/Sync] 无效的 user_id 格式: ${user_id}`)\n      return NextResponse.json({ error: 'Invalid user_id format' }, { status: 400 })\n    }\n\n    // 2. 使用 Service Role Key 创建超级管理员客户端\n    const supabaseAdmin = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // 3. 检查用户是否已存在\n    const { data: existingUser } = await supabaseAdmin\n      .from('user_profiles')\n      .select('user_id')\n      .eq('user_id', user_id)\n      .single()\n\n    // 4. 如果是新用户，执行初始化\n    if (!existingUser) {\n      // 日志优化：如果是手机注册，email可能为空，所以打印 phone 或 user_id\n      console.log(`[Sync] 新用户 ${email || phone || user_id} 初始化中...`)\n\n      // A. 插入个人资料\n      const { error: profileError } = await supabaseAdmin\n        .from('user_profiles')\n        .insert({\n          user_id,\n          email: email || null, // 确保如果是手机注册，email 存为 null 而不是 undefined\n          phone: phone || null, // 【修改点 2】: 将手机号写入数据库\n          \n          // 【修改点 3】: 智能昵称逻辑\n          // 优先级：前端传来的昵称 > 邮箱前缀 > 手机号 > '新用户'\n          nickname: nickname || email?.split('@')[0] || phone || '新用户',\n          \n          avatar_url: avatar\n        })\n      \n      if (profileError) {\n        console.error('创建 Profile 失败:', profileError)\n        // 如果这里报错，通常是因为数据库没有 phone 列，或者字段类型不对\n      }\n\n      // B. ✨ 赠送初始积分 (1000 分) ✨\n      // 🔥 只使用数据库中存在的字段：user_id, credits, is_pro\n      const { error: creditError } = await supabaseAdmin\n        .from('user_credits')\n        .insert({\n          user_id,\n          credits: 1000, \n          is_pro: false\n        })\n\n      if (creditError) {\n        console.error('赠送积分失败:', creditError)\n        // 如果插入失败，尝试 upsert\n        const { error: upsertError } = await supabaseAdmin\n          .from('user_credits')\n          .upsert({\n            user_id,\n            credits: 1000, \n            is_pro: false\n          })\n        if (upsertError) {\n          console.error('Upsert 积分也失败:', upsertError)\n        } else {\n          console.log(`✅ [Sync] 用户 ${user_id} 积分 Upsert 成功`)\n        }\n      } else {\n        console.log(`✅ [Sync] 用户 ${user_id} 赠送 1000 积分成功`)\n      }\n\n      return NextResponse.json({ success: true, message: 'New user initialized' })\n    }\n\n    // 老用户登录，什么都不做\n    return NextResponse.json({ success: true, message: 'User already exists' })\n\n  } catch (error) {\n    console.error('[Sync API Error]', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}