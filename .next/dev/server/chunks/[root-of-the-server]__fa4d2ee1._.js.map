{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/auth/sync/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\nimport { NextResponse } from 'next/server'\n\nexport async function POST(request: Request) {\n  try {\n    // 1. 获取前端传来的用户信息\n    const body = await request.json()\n    // 【修改点 1】: 这里增加了 phone 字段的读取\n    const { user_id, email, nickname, avatar, phone } = body\n\n    if (!user_id) {\n      return NextResponse.json({ error: 'Missing user_id' }, { status: 400 })\n    }\n\n    // 2. 使用 Service Role Key 创建超级管理员客户端\n    const supabaseAdmin = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // 3. 检查用户是否已存在\n    const { data: existingUser } = await supabaseAdmin\n      .from('user_profiles')\n      .select('user_id')\n      .eq('user_id', user_id)\n      .single()\n\n    // 4. 如果是新用户，执行初始化\n    if (!existingUser) {\n      // 日志优化：如果是手机注册，email可能为空，所以打印 phone 或 user_id\n      console.log(`[Sync] 新用户 ${email || phone || user_id} 初始化中...`)\n\n      // A. 插入个人资料\n      const { error: profileError } = await supabaseAdmin\n        .from('user_profiles')\n        .insert({\n          user_id,\n          email: email || null, // 确保如果是手机注册，email 存为 null 而不是 undefined\n          phone: phone || null, // 【修改点 2】: 将手机号写入数据库\n          \n          // 【修改点 3】: 智能昵称逻辑\n          // 优先级：前端传来的昵称 > 邮箱前缀 > 手机号 > '新用户'\n          nickname: nickname || email?.split('@')[0] || phone || '新用户',\n          \n          avatar_url: avatar\n        })\n      \n      if (profileError) {\n        console.error('创建 Profile 失败:', profileError)\n        // 如果这里报错，通常是因为数据库没有 phone 列，或者字段类型不对\n      }\n\n      // B. ✨ 赠送初始积分 (1000 分) ✨\n      const { error: creditError } = await supabaseAdmin\n        .from('user_credits')\n        .insert({\n          user_id,\n          credits: 1000, \n          is_pro: false\n        })\n\n      if (creditError) console.error('赠送积分失败:', creditError)\n\n      return NextResponse.json({ success: true, message: 'New user initialized' })\n    }\n\n    // 老用户登录，什么都不做\n    return NextResponse.json({ success: true, message: 'User already exists' })\n\n  } catch (error) {\n    console.error('[Sync API Error]', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,iBAAiB;QACjB,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,6BAA6B;QAC7B,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG;QAEpD,IAAI,CAAC,SAAS;YACZ,OAAO,uTAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,oCAAoC;QACpC,MAAM,gBAAgB,IAAA,mRAAY,gFAEhC,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,eAAe;QACf,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,cAClC,IAAI,CAAC,iBACL,MAAM,CAAC,WACP,EAAE,CAAC,WAAW,SACd,MAAM;QAET,kBAAkB;QAClB,IAAI,CAAC,cAAc;YACjB,8CAA8C;YAC9C,QAAQ,GAAG,CAAC,CAAC,WAAW,EAAE,SAAS,SAAS,QAAQ,QAAQ,CAAC;YAE7D,YAAY;YACZ,MAAM,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,cACnC,IAAI,CAAC,iBACL,MAAM,CAAC;gBACN;gBACA,OAAO,SAAS;gBAChB,OAAO,SAAS;gBAEhB,kBAAkB;gBAClB,mCAAmC;gBACnC,UAAU,YAAY,OAAO,MAAM,IAAI,CAAC,EAAE,IAAI,SAAS;gBAEvD,YAAY;YACd;YAEF,IAAI,cAAc;gBAChB,QAAQ,KAAK,CAAC,kBAAkB;YAChC,qCAAqC;YACvC;YAEA,yBAAyB;YACzB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,cAClC,IAAI,CAAC,gBACL,MAAM,CAAC;gBACN;gBACA,SAAS;gBACT,QAAQ;YACV;YAEF,IAAI,aAAa,QAAQ,KAAK,CAAC,WAAW;YAE1C,OAAO,uTAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,SAAS;YAAuB;QAC5E;QAEA,cAAc;QACd,OAAO,uTAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAsB;IAE3E,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,uTAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF","debugId":null}}]
}