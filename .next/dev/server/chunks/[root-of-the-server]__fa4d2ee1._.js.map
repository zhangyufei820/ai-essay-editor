{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/auth/sync/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\nimport { NextResponse } from 'next/server'\n\nexport async function POST(request: Request) {\n  try {\n    // 1. 获取前端传来的用户信息\n    const body = await request.json()\n    const { user_id, email, nickname, avatar } = body\n\n    if (!user_id) {\n      return NextResponse.json({ error: 'Missing user_id' }, { status: 400 })\n    }\n\n    // 2. 使用 Service Role Key 创建超级管理员客户端\n    const supabaseAdmin = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // 3. 检查用户是否已存在\n    const { data: existingUser } = await supabaseAdmin\n      .from('user_profiles')\n      .select('user_id')\n      .eq('user_id', user_id)\n      .single()\n\n    // 4. 如果是新用户，执行初始化\n    if (!existingUser) {\n      console.log(`[Sync] 新用户 ${email} 初始化中...`)\n\n      // A. 插入个人资料\n      const { error: profileError } = await supabaseAdmin\n        .from('user_profiles')\n        .insert({\n          user_id,\n          email,\n          nickname: nickname || email?.split('@')[0] || '新用户',\n          avatar_url: avatar\n        })\n      \n      if (profileError) console.error('创建 Profile 失败:', profileError)\n\n      // B. ✨ 赠送初始积分 (这里改成 1000 分) ✨\n      const { error: creditError } = await supabaseAdmin\n        .from('user_credits')\n        .insert({\n          user_id,\n          credits: 1000, \n          is_pro: false\n        })\n\n      if (creditError) console.error('赠送积分失败:', creditError)\n\n      return NextResponse.json({ success: true, message: 'New user initialized' })\n    }\n\n    // 老用户登录，什么都不做\n    return NextResponse.json({ success: true, message: 'User already exists' })\n\n  } catch (error) {\n    console.error('[Sync API Error]', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,iBAAiB;QACjB,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG;QAE7C,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,oCAAoC;QACpC,MAAM,gBAAgB,IAAA,yMAAY,gFAEhC,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,eAAe;QACf,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,cAClC,IAAI,CAAC,iBACL,MAAM,CAAC,WACP,EAAE,CAAC,WAAW,SACd,MAAM;QAET,kBAAkB;QAClB,IAAI,CAAC,cAAc;YACjB,QAAQ,GAAG,CAAC,CAAC,WAAW,EAAE,MAAM,QAAQ,CAAC;YAEzC,YAAY;YACZ,MAAM,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,cACnC,IAAI,CAAC,iBACL,MAAM,CAAC;gBACN;gBACA;gBACA,UAAU,YAAY,OAAO,MAAM,IAAI,CAAC,EAAE,IAAI;gBAC9C,YAAY;YACd;YAEF,IAAI,cAAc,QAAQ,KAAK,CAAC,kBAAkB;YAElD,8BAA8B;YAC9B,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,cAClC,IAAI,CAAC,gBACL,MAAM,CAAC;gBACN;gBACA,SAAS;gBACT,QAAQ;YACV;YAEF,IAAI,aAAa,QAAQ,KAAK,CAAC,WAAW;YAE1C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,SAAS;YAAuB;QAC5E;QAEA,cAAc;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAsB;IAE3E,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF","debugId":null}}]
}