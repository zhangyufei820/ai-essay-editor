{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/dify-upload/route.ts"],"sourcesContent":["import type { NextRequest } from \"next/server\"\n\n// âœ… ä¿®æ”¹ 1: åˆ‡æ¢å› Node.js è¿è¡Œæ—¶ï¼Œä»¥æ”¯æŒæ›´å¤§çš„æ–‡ä»¶å’Œæ›´ç¨³å®šçš„ä¸Šä¼ \nexport const runtime = \"nodejs\" \n\n// å¯é€‰ï¼šè®¾ç½®æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé˜²æ­¢ä¸Šä¼ å¤§æ–‡ä»¶è¶…æ—¶\nexport const maxDuration = 60; \n\nconst DIFY_BASE_URL = process.env.DIFY_BASE_URL || \"https://api.dify.ai/v1\"\nconst DIFY_API_KEY = process.env.DIFY_API_KEY\n\nexport async function POST(request: NextRequest) {\n  if (!DIFY_API_KEY) {\n    return new Response(JSON.stringify({ error: \"Dify API key not configured\" }), {\n      status: 500,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  try {\n    // ğŸ” ä» header è·å–ç”¨æˆ·èº«ä»½ï¼ˆmiddleware å·²éªŒè¯ï¼‰\n    const headerUserId = request.headers.get(\"X-User-Id\")\n    \n    const formData = await request.formData()\n    const file = formData.get(\"file\") as File\n    // ä¼˜å…ˆä½¿ç”¨ header ä¸­çš„ userIdï¼Œå…¶æ¬¡ä½¿ç”¨ formData ä¸­çš„\n    const userId = headerUserId || formData.get(\"user\") as string \n\n    if (!file) {\n      return new Response(JSON.stringify({ error: \"No file provided\" }), {\n        status: 400,\n        headers: { \"Content-Type\": \"application/json\" },\n      })\n    }\n\n    // ğŸ” äºŒæ¬¡éªŒè¯ï¼šç¡®ä¿æœ‰ç”¨æˆ·èº«ä»½\n    if (!userId) {\n      return new Response(JSON.stringify({ error: \"æœªæˆæƒè®¿é—®ï¼Œè¯·å…ˆç™»å½•\" }), {\n        status: 401,\n        headers: { \"Content-Type\": \"application/json\" },\n      })\n    }\n\n    const difyFormData = new FormData()\n    difyFormData.append(\"file\", file)\n    // âœ… ä¿®æ”¹ 3: ä½¿ç”¨çœŸå®çš„ç”¨æˆ· IDï¼Œä¿æŒä¸å¯¹è¯æ¥å£ä¸€è‡´\n    difyFormData.append(\"user\", userId || \"anonymous-user\") \n\n    // Dify æ–‡ä»¶ä¸Šä¼ çš„æ­£ç¡®ç«¯ç‚¹\n    const uploadUrl = `${DIFY_BASE_URL}/files/upload`\n\n    const response = await fetch(uploadUrl, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${DIFY_API_KEY}`,\n        // æ³¨æ„ï¼šä½¿ç”¨ fetch å‘é€ FormData æ—¶ï¼Œé€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® Content-Typeï¼Œ\n        // æµè§ˆå™¨/Nodeç¯å¢ƒä¼šè‡ªåŠ¨ç”Ÿæˆå¸¦ boundary çš„æ­£ç¡® Header\n      },\n      body: difyFormData,\n    })\n\n    if (!response.ok) {\n      const errorText = await response.text()\n      console.error(\"[Backend] Dify upload failed:\", {\n        status: response.status,\n        url: uploadUrl,\n        error: errorText,\n      })\n\n      return new Response(\n        JSON.stringify({\n          error: \"File upload to Dify failed\",\n          details: errorText,\n          status: response.status,\n        }),\n        {\n          status: response.status,\n          headers: { \"Content-Type\": \"application/json\" },\n        },\n      )\n    }\n\n    const data = await response.json()\n    console.log(\"[Backend] Dify upload success:\", { fileId: data.id, fileName: file.name, userId })\n\n    return new Response(JSON.stringify(data), {\n      status: 200,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  } catch (error) {\n    console.error(\"[Backend] Upload error:\", error)\n    return new Response(\n      JSON.stringify({\n        error: \"Internal server error\",\n        details: error instanceof Error ? error.message : String(error),\n      }),\n      {\n        status: 500,\n        headers: { \"Content-Type\": \"application/json\" },\n      },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAGO,MAAM,UAAU;AAGhB,MAAM,cAAc;AAE3B,MAAM,gBAAgB,QAAQ,GAAG,CAAC,aAAa,IAAI;AACnD,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;AAEtC,eAAe,KAAK,OAAoB;IAC7C,IAAI,CAAC,cAAc;QACjB,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,OAAO;QAA8B,IAAI;YAC5E,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;IACF;IAEA,IAAI;QACF,qCAAqC;QACrC,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC;QAEzC,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,yCAAyC;QACzC,MAAM,SAAS,gBAAgB,SAAS,GAAG,CAAC;QAE5C,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;gBAAE,OAAO;YAAmB,IAAI;gBACjE,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;QACF;QAEA,kBAAkB;QAClB,IAAI,CAAC,QAAQ;YACX,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;gBAAE,OAAO;YAAa,IAAI;gBAC3D,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;QACF;QAEA,MAAM,eAAe,IAAI;QACzB,aAAa,MAAM,CAAC,QAAQ;QAC5B,+BAA+B;QAC/B,aAAa,MAAM,CAAC,QAAQ,UAAU;QAEtC,iBAAiB;QACjB,MAAM,YAAY,GAAG,cAAc,aAAa,CAAC;QAEjD,MAAM,WAAW,MAAM,MAAM,WAAW;YACtC,QAAQ;YACR,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,cAAc;YAGzC;YACA,MAAM;QACR;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,QAAQ,KAAK,CAAC,iCAAiC;gBAC7C,QAAQ,SAAS,MAAM;gBACvB,KAAK;gBACL,OAAO;YACT;YAEA,OAAO,IAAI,SACT,KAAK,SAAS,CAAC;gBACb,OAAO;gBACP,SAAS;gBACT,QAAQ,SAAS,MAAM;YACzB,IACA;gBACE,QAAQ,SAAS,MAAM;gBACvB,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;QAEJ;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,QAAQ,GAAG,CAAC,kCAAkC;YAAE,QAAQ,KAAK,EAAE;YAAE,UAAU,KAAK,IAAI;YAAE;QAAO;QAE7F,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC,OAAO;YACxC,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,IAAI,SACT,KAAK,SAAS,CAAC;YACb,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;QAC3D,IACA;YACE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;IAEJ;AACF","debugId":null}}]
}