{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/login/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useEffect, useRef, useState, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\n\nfunction AuthingLoginComponent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  \n  // 这是你之前提供的 Authing App ID\n  const appId = '692b0bd30de159be78db726b' \n  const guardRef = useRef<any>(null)\n  const [isLoaded, setIsLoaded] = useState(false)\n\n  useEffect(() => {\n    // 1. 检查是否已经登录\n    // 如果已经有用户信息，直接跳转，不再显示登录框\n    const user = localStorage.getItem('currentUser')\n    if (user) {\n      const redirectPath = searchParams.get('redirect')\n      router.replace(redirectPath || '/')\n      return\n    }\n\n    if (guardRef.current) return\n\n    // 2. 动态加载 Authing 样式\n    const link = document.createElement('link')\n    link.rel = 'stylesheet'\n    link.href = 'https://cdn.authing.co/packages/guard/latest/guard.min.css'\n    document.head.appendChild(link)\n\n    // 3. 加载 Authing 组件\n    import('@authing/guard').then((module) => {\n      const Guard = module.Guard\n      if (guardRef.current) return\n\n      const guard = new Guard({\n        appId,\n        mode: 'normal', // 使用普通模式，不强制跳转\n      })\n\n      // ✅ 登录成功的处理逻辑\n      guard.on('login', async (userInfo: any) => {\n        console.log('登录成功:', userInfo)\n        \n        // [关键] 保存用户信息到浏览器，以便支付页面能看到\n        const finalUser = userInfo.data || userInfo\n        localStorage.setItem('currentUser', JSON.stringify(finalUser))\n\n        // 可选：同步到你的后端数据库 (保留了你之前的逻辑)\n        try {\n          await fetch('/api/auth/sync', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              user_id: finalUser.id || finalUser.sub,\n              email: finalUser.email,\n              nickname: finalUser.nickname || finalUser.username,\n              avatar: finalUser.photo,\n              // ✨ [新增] 同步手机号\n              // Authing 返回的手机号字段可能是 phone 或 phone_number\n              phone: finalUser.phone || finalUser.phone_number \n            })\n          })\n        } catch(e) {\n          console.error('同步失败', e)\n        }\n\n        // [关键] 登录后跳转回刚才的页面（比如支付页）\n        const redirectPath = searchParams.get('redirect')\n        \n        if (redirectPath) {\n          console.log('正在返回之前的页面:', redirectPath)\n          // 使用 decodeURIComponent 确保网址格式正确\n          router.replace(decodeURIComponent(redirectPath))\n        } else {\n          router.replace('/')\n        }\n      })\n\n      guard.start('#authing-guard-container')\n      guardRef.current = guard\n      setIsLoaded(true)\n    })\n  }, [appId, router, searchParams])\n\n  return (\n    <div style={{ \n      height: '100vh', \n      display: 'flex', \n      flexDirection: 'column', \n      justifyContent: 'center', \n      alignItems: 'center', \n      backgroundColor: '#f5f5f5' \n    }}>\n      {/* 登录框容器 */}\n      <div id=\"authing-guard-container\" style={{ minHeight: '500px' }}></div>\n      \n      {!isLoaded && (\n        <p style={{ color: '#666', marginTop: '20px' }}>\n          正在加载安全登录组件...\n        </p>\n      )}\n    </div>\n  )\n}\n\n// 必须使用 Suspense 包裹，否则在 Next.js 新版本中可能会报错\nexport default function LoginPage() {\n  return (\n    <Suspense fallback={<div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>加载中...</div>}>\n      <AuthingLoginComponent />\n    </Suspense>\n  )\n}"],"names":[],"mappings":";;;;;AAEA;AACA;AAHA;;;;AAKA,SAAS;IACP,MAAM,SAAS,IAAA,sTAAS;IACxB,MAAM,eAAe,IAAA,4TAAe;IAEpC,0BAA0B;IAC1B,MAAM,QAAQ;IACd,MAAM,WAAW,IAAA,sXAAM,EAAM;IAC7B,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,wXAAQ,EAAC;IAEzC,IAAA,yXAAS,EAAC;QACR,cAAc;QACd,yBAAyB;QACzB,MAAM,OAAO,aAAa,OAAO,CAAC;QAClC,IAAI,MAAM;YACR,MAAM,eAAe,aAAa,GAAG,CAAC;YACtC,OAAO,OAAO,CAAC,gBAAgB;YAC/B;QACF;QAEA,IAAI,SAAS,OAAO,EAAE;QAEtB,qBAAqB;QACrB,MAAM,OAAO,SAAS,aAAa,CAAC;QACpC,KAAK,GAAG,GAAG;QACX,KAAK,IAAI,GAAG;QACZ,SAAS,IAAI,CAAC,WAAW,CAAC;QAE1B,mBAAmB;QACnB,2LAAyB,IAAI,CAAC,CAAC;YAC7B,MAAM,QAAQ,OAAO,KAAK;YAC1B,IAAI,SAAS,OAAO,EAAE;YAEtB,MAAM,QAAQ,IAAI,MAAM;gBACtB;gBACA,MAAM;YACR;YAEA,cAAc;YACd,MAAM,EAAE,CAAC,SAAS,OAAO;gBACvB,QAAQ,GAAG,CAAC,SAAS;gBAErB,4BAA4B;gBAC5B,MAAM,YAAY,SAAS,IAAI,IAAI;gBACnC,aAAa,OAAO,CAAC,eAAe,KAAK,SAAS,CAAC;gBAEnD,4BAA4B;gBAC5B,IAAI;oBACF,MAAM,MAAM,kBAAkB;wBAC5B,QAAQ;wBACR,SAAS;4BAAE,gBAAgB;wBAAmB;wBAC9C,MAAM,KAAK,SAAS,CAAC;4BACnB,SAAS,UAAU,EAAE,IAAI,UAAU,GAAG;4BACtC,OAAO,UAAU,KAAK;4BACtB,UAAU,UAAU,QAAQ,IAAI,UAAU,QAAQ;4BAClD,QAAQ,UAAU,KAAK;4BACvB,eAAe;4BACf,2CAA2C;4BAC3C,OAAO,UAAU,KAAK,IAAI,UAAU,YAAY;wBAClD;oBACF;gBACF,EAAE,OAAM,GAAG;oBACT,QAAQ,KAAK,CAAC,QAAQ;gBACxB;gBAEA,0BAA0B;gBAC1B,MAAM,eAAe,aAAa,GAAG,CAAC;gBAEtC,IAAI,cAAc;oBAChB,QAAQ,GAAG,CAAC,cAAc;oBAC1B,iCAAiC;oBACjC,OAAO,OAAO,CAAC,mBAAmB;gBACpC,OAAO;oBACL,OAAO,OAAO,CAAC;gBACjB;YACF;YAEA,MAAM,KAAK,CAAC;YACZ,SAAS,OAAO,GAAG;YACnB,YAAY;QACd;IACF,GAAG;QAAC;QAAO;QAAQ;KAAa;IAEhC,qBACE,qZAAC;QAAI,OAAO;YACV,QAAQ;YACR,SAAS;YACT,eAAe;YACf,gBAAgB;YAChB,YAAY;YACZ,iBAAiB;QACnB;;0BAEE,qZAAC;gBAAI,IAAG;gBAA0B,OAAO;oBAAE,WAAW;gBAAQ;;;;;;YAE7D,CAAC,0BACA,qZAAC;gBAAE,OAAO;oBAAE,OAAO;oBAAQ,WAAW;gBAAO;0BAAG;;;;;;;;;;;;AAMxD;AAGe,SAAS;IACtB,qBACE,qZAAC,wXAAQ;QAAC,wBAAU,qZAAC;YAAI,OAAO;gBAAE,QAAQ;gBAAS,SAAS;gBAAQ,gBAAgB;gBAAU,YAAY;YAAS;sBAAG;;;;;;kBACpH,cAAA,qZAAC;;;;;;;;;;AAGP","debugId":null}}]
}