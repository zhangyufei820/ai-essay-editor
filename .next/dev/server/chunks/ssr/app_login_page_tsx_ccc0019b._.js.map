{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/login/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useEffect, useRef, useState, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\n\nfunction AuthingLoginComponent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  \n  // 从环境变量读取 Authing App ID\n  const appId = process.env.NEXT_PUBLIC_AUTHING_APP_ID || ''\n  const guardRef = useRef<any>(null)\n  const [isLoaded, setIsLoaded] = useState(false)\n\n  useEffect(() => {\n    // 1. 检查是否已经登录\n    // 如果已经有用户信息，直接跳转，不再显示登录框\n    const user = localStorage.getItem('currentUser')\n    if (user) {\n      const redirectPath = searchParams.get('redirect')\n      router.replace(redirectPath || '/')\n      return\n    }\n\n    if (guardRef.current) return\n\n    // 2. 动态加载 Authing 样式\n    const link = document.createElement('link')\n    link.rel = 'stylesheet'\n    link.href = 'https://cdn.authing.co/packages/guard/latest/guard.min.css'\n    document.head.appendChild(link)\n\n    // 3. 加载 Authing 组件\n    import('@authing/guard').then((module) => {\n      const Guard = module.Guard\n      if (guardRef.current) return\n\n      try {\n        const guard = new Guard({\n          appId,\n          mode: 'normal', // 使用普通模式，不强制跳转\n        })\n\n      // ✅ 登录成功的处理逻辑\n      guard.on('login', async (userInfo: any) => {\n        console.log('登录成功:', userInfo)\n        \n        // [关键] 保存用户信息到浏览器，以便支付页面能看到\n        const finalUser = userInfo.data || userInfo\n        localStorage.setItem('currentUser', JSON.stringify(finalUser))\n\n        // 可选：同步到你的后端数据库 (保留了你之前的逻辑)\n        try {\n          await fetch('/api/auth/sync', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              user_id: finalUser.id || finalUser.sub,\n              email: finalUser.email,\n              nickname: finalUser.nickname || finalUser.username,\n              avatar: finalUser.photo,\n              // ✨ [新增] 同步手机号\n              // Authing 返回的手机号字段可能是 phone 或 phone_number\n              phone: finalUser.phone || finalUser.phone_number \n            })\n          })\n        } catch(e) {\n          console.error('同步失败', e)\n        }\n\n        // [关键] 登录后跳转回刚才的页面（比如支付页）\n        const redirectPath = searchParams.get('redirect')\n        \n        if (redirectPath) {\n          console.log('正在返回之前的页面:', redirectPath)\n          // 使用 decodeURIComponent 确保网址格式正确\n          router.replace(decodeURIComponent(redirectPath))\n        } else {\n          router.replace('/')\n        }\n      })\n\n        guard.start('#authing-guard-container')\n        guardRef.current = guard\n        setIsLoaded(true)\n      } catch (error) {\n        console.error('Authing Guard 初始化失败:', error)\n        setIsLoaded(true) // 即使失败也标记为已加载，避免无限等待\n      }\n    }).catch((error) => {\n      console.error('加载 Authing 模块失败:', error)\n      setIsLoaded(true)\n    })\n  }, [appId, router, searchParams])\n\n  return (\n    <div style={{ \n      height: '100vh', \n      display: 'flex', \n      flexDirection: 'column', \n      justifyContent: 'center', \n      alignItems: 'center', \n      backgroundColor: '#f5f5f5' \n    }}>\n      {/* 登录框容器 */}\n      <div id=\"authing-guard-container\" style={{ minHeight: '500px' }}></div>\n      \n      {!isLoaded && (\n        <p style={{ color: '#666', marginTop: '20px' }}>\n          正在加载安全登录组件...\n        </p>\n      )}\n    </div>\n  )\n}\n\n// 必须使用 Suspense 包裹，否则在 Next.js 新版本中可能会报错\nexport default function LoginPage() {\n  return (\n    <Suspense fallback={<div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>加载中...</div>}>\n      <AuthingLoginComponent />\n    </Suspense>\n  )\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAHA;;;;AAKA,SAAS;IACP,MAAM,SAAS,IAAA,wVAAS;IACxB,MAAM,eAAe,IAAA,8VAAe;IAEpC,yBAAyB;IACzB,MAAM,QAAQ,gEAA0C;IACxD,MAAM,WAAW,IAAA,wZAAM,EAAM;IAC7B,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,0ZAAQ,EAAC;IAEzC,IAAA,2ZAAS,EAAC;QACR,cAAc;QACd,yBAAyB;QACzB,MAAM,OAAO,aAAa,OAAO,CAAC;QAClC,IAAI,MAAM;YACR,MAAM,eAAe,aAAa,GAAG,CAAC;YACtC,OAAO,OAAO,CAAC,gBAAgB;YAC/B;QACF;QAEA,IAAI,SAAS,OAAO,EAAE;QAEtB,qBAAqB;QACrB,MAAM,OAAO,SAAS,aAAa,CAAC;QACpC,KAAK,GAAG,GAAG;QACX,KAAK,IAAI,GAAG;QACZ,SAAS,IAAI,CAAC,WAAW,CAAC;QAE1B,mBAAmB;QACnB,2LAAyB,IAAI,CAAC,CAAC;YAC7B,MAAM,QAAQ,OAAO,KAAK;YAC1B,IAAI,SAAS,OAAO,EAAE;YAEtB,IAAI;gBACF,MAAM,QAAQ,IAAI,MAAM;oBACtB;oBACA,MAAM;gBACR;gBAEF,cAAc;gBACd,MAAM,EAAE,CAAC,SAAS,OAAO;oBACvB,QAAQ,GAAG,CAAC,SAAS;oBAErB,4BAA4B;oBAC5B,MAAM,YAAY,SAAS,IAAI,IAAI;oBACnC,aAAa,OAAO,CAAC,eAAe,KAAK,SAAS,CAAC;oBAEnD,4BAA4B;oBAC5B,IAAI;wBACF,MAAM,MAAM,kBAAkB;4BAC5B,QAAQ;4BACR,SAAS;gCAAE,gBAAgB;4BAAmB;4BAC9C,MAAM,KAAK,SAAS,CAAC;gCACnB,SAAS,UAAU,EAAE,IAAI,UAAU,GAAG;gCACtC,OAAO,UAAU,KAAK;gCACtB,UAAU,UAAU,QAAQ,IAAI,UAAU,QAAQ;gCAClD,QAAQ,UAAU,KAAK;gCACvB,eAAe;gCACf,2CAA2C;gCAC3C,OAAO,UAAU,KAAK,IAAI,UAAU,YAAY;4BAClD;wBACF;oBACF,EAAE,OAAM,GAAG;wBACT,QAAQ,KAAK,CAAC,QAAQ;oBACxB;oBAEA,0BAA0B;oBAC1B,MAAM,eAAe,aAAa,GAAG,CAAC;oBAEtC,IAAI,cAAc;wBAChB,QAAQ,GAAG,CAAC,cAAc;wBAC1B,iCAAiC;wBACjC,OAAO,OAAO,CAAC,mBAAmB;oBACpC,OAAO;wBACL,OAAO,OAAO,CAAC;oBACjB;gBACF;gBAEE,MAAM,KAAK,CAAC;gBACZ,SAAS,OAAO,GAAG;gBACnB,YAAY;YACd,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,wBAAwB;gBACtC,YAAY,OAAM,qBAAqB;YACzC;QACF,GAAG,KAAK,CAAC,CAAC;YACR,QAAQ,KAAK,CAAC,oBAAoB;YAClC,YAAY;QACd;IACF,GAAG;QAAC;QAAO;QAAQ;KAAa;IAEhC,qBACE,ubAAC;QAAI,OAAO;YACV,QAAQ;YACR,SAAS;YACT,eAAe;YACf,gBAAgB;YAChB,YAAY;YACZ,iBAAiB;QACnB;;0BAEE,ubAAC;gBAAI,IAAG;gBAA0B,OAAO;oBAAE,WAAW;gBAAQ;;;;;;YAE7D,CAAC,0BACA,ubAAC;gBAAE,OAAO;oBAAE,OAAO;oBAAQ,WAAW;gBAAO;0BAAG;;;;;;;;;;;;AAMxD;AAGe,SAAS;IACtB,qBACE,ubAAC,0ZAAQ;QAAC,wBAAU,ubAAC;YAAI,OAAO;gBAAE,QAAQ;gBAAS,SAAS;gBAAQ,gBAAgB;gBAAU,YAAY;YAAS;sBAAG;;;;;;kBACpH,cAAA,ubAAC;;;;;;;;;;AAGP","debugId":null}}]
}