{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/user/credits/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\nimport { NextResponse } from 'next/server'\n\n/**\n * ğŸ¯ ç”¨æˆ·ç§¯åˆ†æŸ¥è¯¢ API\n * \n * GET /api/user/credits?user_id=xxx\n * \n * ä½¿ç”¨ Service Role Key æŸ¥è¯¢ï¼Œç»•è¿‡ RLS é™åˆ¶\n */\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const userId = searchParams.get('user_id')\n\n    if (!userId) {\n      return NextResponse.json({ error: 'Missing user_id' }, { status: 400 })\n    }\n\n    console.log(`ğŸ” [ç§¯åˆ†API] æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†: ${userId}`)\n\n    // ä½¿ç”¨ Service Role Key åˆ›å»ºè¶…çº§ç®¡ç†å‘˜å®¢æˆ·ç«¯\n    const supabaseAdmin = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    // æŸ¥è¯¢ç§¯åˆ†\n    const { data: creditData, error } = await supabaseAdmin\n      .from('user_credits')\n      .select('credits, is_pro')\n      .eq('user_id', userId)\n      .maybeSingle()\n\n    if (error) {\n      console.error(`âŒ [ç§¯åˆ†API] æŸ¥è¯¢å¤±è´¥:`, error)\n      return NextResponse.json({ error: error.message }, { status: 500 })\n    }\n\n    // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œè‡ªåŠ¨åˆ›å»º\n    if (!creditData) {\n      console.log(`ğŸ†• [ç§¯åˆ†API] ç”¨æˆ· ${userId} æ— ç§¯åˆ†è®°å½•ï¼Œè‡ªåŠ¨åˆ›å»º...`)\n      \n      const { data: newData, error: insertError } = await supabaseAdmin\n        .from('user_credits')\n        .upsert({\n          user_id: userId,\n          credits: 1000,\n          is_pro: false\n        })\n        .select('credits, is_pro')\n        .single()\n\n      if (insertError) {\n        console.error(`âŒ [ç§¯åˆ†API] åˆ›å»ºç§¯åˆ†è®°å½•å¤±è´¥:`, insertError)\n        // å³ä½¿åˆ›å»ºå¤±è´¥ï¼Œä¹Ÿè¿”å›é»˜è®¤å€¼\n        return NextResponse.json({ \n          credits: 1000, \n          is_pro: false,\n          isNew: true \n        })\n      }\n\n      console.log(`âœ… [ç§¯åˆ†API] æ–°ç”¨æˆ·ç§¯åˆ†åˆå§‹åŒ–æˆåŠŸ:`, newData)\n      return NextResponse.json({ \n        credits: newData?.credits || 1000, \n        is_pro: newData?.is_pro || false,\n        isNew: true \n      })\n    }\n\n    console.log(`âœ… [ç§¯åˆ†API] æŸ¥è¯¢æˆåŠŸ: credits=${creditData.credits}`)\n    return NextResponse.json({ \n      credits: creditData.credits, \n      is_pro: creditData.is_pro \n    })\n\n  } catch (error) {\n    console.error('[ç§¯åˆ†API] å¼‚å¸¸:', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAUO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,CAAC,QAAQ;YACX,OAAO,yVAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,QAAQ;QAE1C,iCAAiC;QACjC,MAAM,gBAAgB,IAAA,mRAAY,gFAEhC,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,OAAO;QACP,MAAM,EAAE,MAAM,UAAU,EAAE,KAAK,EAAE,GAAG,MAAM,cACvC,IAAI,CAAC,gBACL,MAAM,CAAC,mBACP,EAAE,CAAC,WAAW,QACd,WAAW;QAEd,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,CAAC,eAAe,CAAC,EAAE;YACjC,OAAO,yVAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACnE;QAEA,cAAc;QACd,IAAI,CAAC,YAAY;YACf,QAAQ,GAAG,CAAC,CAAC,cAAc,EAAE,OAAO,cAAc,CAAC;YAEnD,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,cACjD,IAAI,CAAC,gBACL,MAAM,CAAC;gBACN,SAAS;gBACT,SAAS;gBACT,QAAQ;YACV,GACC,MAAM,CAAC,mBACP,MAAM;YAET,IAAI,aAAa;gBACf,QAAQ,KAAK,CAAC,CAAC,mBAAmB,CAAC,EAAE;gBACrC,gBAAgB;gBAChB,OAAO,yVAAY,CAAC,IAAI,CAAC;oBACvB,SAAS;oBACT,QAAQ;oBACR,OAAO;gBACT;YACF;YAEA,QAAQ,GAAG,CAAC,CAAC,qBAAqB,CAAC,EAAE;YACrC,OAAO,yVAAY,CAAC,IAAI,CAAC;gBACvB,SAAS,SAAS,WAAW;gBAC7B,QAAQ,SAAS,UAAU;gBAC3B,OAAO;YACT;QACF;QAEA,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,WAAW,OAAO,EAAE;QAC3D,OAAO,yVAAY,CAAC,IAAI,CAAC;YACvB,SAAS,WAAW,OAAO;YAC3B,QAAQ,WAAW,MAAM;QAC3B;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,yVAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF","debugId":null}}]
}