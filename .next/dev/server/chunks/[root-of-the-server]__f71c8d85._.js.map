{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createServerClient() {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!supabaseUrl || !supabaseKey) {\n    throw new Error(\"Supabase not configured\")\n  }\n\n  const cookieStore = await cookies()\n\n  return createSupabaseServerClient(supabaseUrl, supabaseKey, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n          // This can be ignored if you have middleware refreshing\n          // user sessions.\n        }\n      },\n    },\n  })\n}\n\nexport async function createClient() {\n  return createServerClient()\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM;IACN,MAAM;IAEN;;IAIA,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAA0B,EAAC,aAAa,aAAa;QAC1D,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF;AAEO,eAAe;IACpB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/lib/xunhupay.ts"],"sourcesContent":["import crypto from \"crypto\"\n\nexport interface XunhupayConfig {\n  appId: string\n  appSecret: string\n  gateway: string\n  notifyUrl: string\n  returnUrl: string\n}\n\nexport const xunhupayConfig: XunhupayConfig = {\n  appId: process.env.XUNHUPAY_APP_ID || \"2019061715339\",\n  appSecret: process.env.XUNHUPAY_APP_SECRET || \"c09c917331de8d12ee6561a1af6c9ab9\",\n  gateway: \"https://api.xunhupay.com/payment/do.html\",\n  notifyUrl: process.env.NEXT_PUBLIC_APP_URL + \"/api/payment/xunhupay/notify\",\n  returnUrl: process.env.NEXT_PUBLIC_APP_URL + \"/payment/success\",\n}\n\n// 生成签名 (MD5)\nfunction generateSign(params: Record<string, any>, appSecret: string): string {\n  // 按照key排序并拼接\n  const sortedKeys = Object.keys(params).sort()\n  const signString = sortedKeys.map((key) => `${key}=${params[key]}`).join(\"&\")\n  const stringWithSecret = `${signString}&key=${appSecret}`\n\n  // MD5签名\n  return crypto.createHash(\"md5\").update(stringWithSecret, \"utf8\").digest(\"hex\").toLowerCase()\n}\n\n// 验证签名\nexport function verifyXunhupaySign(params: Record<string, any>): boolean {\n  const receivedSign = params.sign\n  const paramsWithoutSign = { ...params }\n  delete paramsWithoutSign.sign\n\n  const calculatedSign = generateSign(paramsWithoutSign, xunhupayConfig.appSecret)\n  return receivedSign === calculatedSign\n}\n\n// 创建支付订单\nexport function createXunhupayOrder(params: {\n  outTradeNo: string\n  totalAmount: string\n  subject: string\n  body?: string\n  paymentType?: \"alipay\" | \"wechat\"\n}): string {\n  const orderParams = {\n    version: \"1.1\",\n    appid: xunhupayConfig.appId,\n    trade_order_id: params.outTradeNo,\n    total_fee: params.totalAmount,\n    title: params.subject,\n    description: params.body || params.subject,\n    time: Math.floor(Date.now() / 1000).toString(),\n    notify_url: xunhupayConfig.notifyUrl,\n    return_url: xunhupayConfig.returnUrl,\n    type: params.paymentType || \"alipay\", // 默认支付宝\n    nonce_str: crypto.randomBytes(16).toString(\"hex\"),\n  }\n\n  // 生成签名\n  const sign = generateSign(orderParams, xunhupayConfig.appSecret)\n\n  const paramsWithSign = {\n    ...orderParams,\n    sign,\n    hash: \"md5\",\n  }\n\n  // 生成支付URL\n  const queryString = Object.keys(paramsWithSign)\n    .map((key) => `${key}=${encodeURIComponent(paramsWithSign[key as keyof typeof paramsWithSign])}`)\n    .join(\"&\")\n\n  return `${xunhupayConfig.gateway}?${queryString}`\n}\n\n// 查询订单状态\nexport async function queryXunhupayOrder(outTradeNo: string) {\n  const queryParams = {\n    appid: xunhupayConfig.appId,\n    out_trade_order: outTradeNo,\n    time: Math.floor(Date.now() / 1000).toString(),\n    nonce_str: crypto.randomBytes(16).toString(\"hex\"),\n  }\n\n  const sign = generateSign(queryParams, xunhupayConfig.appSecret)\n\n  const paramsWithSign = {\n    ...queryParams,\n    sign,\n    hash: \"md5\",\n  }\n\n  const queryString = Object.keys(paramsWithSign)\n    .map((key) => `${key}=${encodeURIComponent(paramsWithSign[key as keyof typeof paramsWithSign])}`)\n    .join(\"&\")\n\n  const response = await fetch(`https://api.xunhupay.com/payment/query?${queryString}`)\n  return response.json()\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAUO,MAAM,iBAAiC;IAC5C,OAAO,QAAQ,GAAG,CAAC,eAAe,IAAI;IACtC,WAAW,QAAQ,GAAG,CAAC,mBAAmB,IAAI;IAC9C,SAAS;IACT,WAAW,QAAQ,GAAG,CAAC,mBAAmB,GAAG;IAC7C,WAAW,QAAQ,GAAG,CAAC,mBAAmB,GAAG;AAC/C;AAEA,aAAa;AACb,SAAS,aAAa,MAA2B,EAAE,SAAiB;IAClE,aAAa;IACb,MAAM,aAAa,OAAO,IAAI,CAAC,QAAQ,IAAI;IAC3C,MAAM,aAAa,WAAW,GAAG,CAAC,CAAC,MAAQ,GAAG,IAAI,CAAC,EAAE,MAAM,CAAC,IAAI,EAAE,EAAE,IAAI,CAAC;IACzE,MAAM,mBAAmB,GAAG,WAAW,KAAK,EAAE,WAAW;IAEzD,QAAQ;IACR,OAAO,gHAAM,CAAC,UAAU,CAAC,OAAO,MAAM,CAAC,kBAAkB,QAAQ,MAAM,CAAC,OAAO,WAAW;AAC5F;AAGO,SAAS,mBAAmB,MAA2B;IAC5D,MAAM,eAAe,OAAO,IAAI;IAChC,MAAM,oBAAoB;QAAE,GAAG,MAAM;IAAC;IACtC,OAAO,kBAAkB,IAAI;IAE7B,MAAM,iBAAiB,aAAa,mBAAmB,eAAe,SAAS;IAC/E,OAAO,iBAAiB;AAC1B;AAGO,SAAS,oBAAoB,MAMnC;IACC,MAAM,cAAc;QAClB,SAAS;QACT,OAAO,eAAe,KAAK;QAC3B,gBAAgB,OAAO,UAAU;QACjC,WAAW,OAAO,WAAW;QAC7B,OAAO,OAAO,OAAO;QACrB,aAAa,OAAO,IAAI,IAAI,OAAO,OAAO;QAC1C,MAAM,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK,MAAM,QAAQ;QAC5C,YAAY,eAAe,SAAS;QACpC,YAAY,eAAe,SAAS;QACpC,MAAM,OAAO,WAAW,IAAI;QAC5B,WAAW,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC7C;IAEA,OAAO;IACP,MAAM,OAAO,aAAa,aAAa,eAAe,SAAS;IAE/D,MAAM,iBAAiB;QACrB,GAAG,WAAW;QACd;QACA,MAAM;IACR;IAEA,UAAU;IACV,MAAM,cAAc,OAAO,IAAI,CAAC,gBAC7B,GAAG,CAAC,CAAC,MAAQ,GAAG,IAAI,CAAC,EAAE,mBAAmB,cAAc,CAAC,IAAmC,GAAG,EAC/F,IAAI,CAAC;IAER,OAAO,GAAG,eAAe,OAAO,CAAC,CAAC,EAAE,aAAa;AACnD;AAGO,eAAe,mBAAmB,UAAkB;IACzD,MAAM,cAAc;QAClB,OAAO,eAAe,KAAK;QAC3B,iBAAiB;QACjB,MAAM,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK,MAAM,QAAQ;QAC5C,WAAW,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC7C;IAEA,MAAM,OAAO,aAAa,aAAa,eAAe,SAAS;IAE/D,MAAM,iBAAiB;QACrB,GAAG,WAAW;QACd;QACA,MAAM;IACR;IAEA,MAAM,cAAc,OAAO,IAAI,CAAC,gBAC7B,GAAG,CAAC,CAAC,MAAQ,GAAG,IAAI,CAAC,EAAE,mBAAmB,cAAc,CAAC,IAAmC,GAAG,EAC/F,IAAI,CAAC;IAER,MAAM,WAAW,MAAM,MAAM,CAAC,uCAAuC,EAAE,aAAa;IACpF,OAAO,SAAS,IAAI;AACtB","debugId":null}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/lib/products.ts"],"sourcesContent":["export interface Product {\n  id: string\n  name: string\n  description: string\n  priceInCents: number // 价格（单位：分）\n  features: string[]\n  popular?: boolean\n}\n\n// 产品目录 - 所有价格的唯一真实来源\n// [!!!] 修复：这里的 ID 必须与 pricing.tsx 中的 ID 完全匹配 [!!!]\nexport const PRODUCTS: Product[] = [\n  // --- 订阅方案 (来自 pricing.tsx) ---\n  {\n    id: \"basic\",\n    name: \"基础版\",\n    description: \"适合入门体验\",\n    priceInCents: 2800, // 28 元 * 100\n    features: [\"每月 2,000 积分\", \"调用所有 AI 模型\", \"标准生成速度\", \"社区支持\", \"调用专业智能体\"],\n  },\n  {\n    id: \"pro\",\n    name: \"专业版\",\n    description: \"适合高频学生\",\n    priceInCents: 6800, // 68 元 * 100\n    features: [\n      \"每月 5,000 积分\",\n      \"调用所有 AI 模型\",\n      \"优先生成速度\",\n      \"高级润色工具\",\n      \"名师辅导 (1次/月)\",\n      \"调用专业智能体\",\n    ],\n    popular: true,\n  },\n  {\n    id: \"premium\",\n    name: \"豪华版\",\n    description: \"适合重度用户/教育者\",\n    priceInCents: 12800, // 128 元 * 100\n    features: [\n      \"每月 12,000 积分\",\n      \"调用三大顶尖模型\",\n      \"最高优先速度\",\n      \"高级润色工具\",\n      \"名师辅导 (2次/月)\",\n      \"无限次 AI 对话\",\n      \"调用专业智能体\",\n    ],\n  },\n\n  // --- 积分充值包 (来自 pricing.tsx) ---\n  {\n    id: \"credits-500\",\n    name: \"500 积分充值包\",\n    description: \"永久有效，适合轻度或测试用户\",\n    priceInCents: 500, // 5 元 * 100\n    features: [\"500 积分\", \"永久有效\", \"可用于生成作文或兑换辅导\"],\n  },\n  {\n    id: \"credits-1000\",\n    name: \"1000 积分充值包\",\n    description: \"永久有效，适合轻度或测试用户\",\n    priceInCents: 1000, // 10 元 * 100\n    features: [\"1000 积分\", \"永久有效\", \"可用于生成作文或兑换辅导\"],\n  },\n  {\n    id: \"credits-5000\",\n    name: \"5000 积分充值包\",\n    description: \"永久有效 (96折优惠)\",\n    priceInCents: 4800, // 48 元 * 100\n    features: [\"5000 积分\", \"永久有效\", \"可用于生成作文或兑换辅导\"],\n  },\n  {\n    id: \"credits-10000\",\n    name: \"10000 积分充值包\",\n    description: \"永久有效 (9折优惠)\",\n    priceInCents: 9000, // 90 元 * 100\n    features: [\"10000 积分\", \"永久有效\", \"可用于生成作文或兑换辅导\"],\n  },\n]"],"names":[],"mappings":";;;;AAWO,MAAM,WAAsB;IACjC,gCAAgC;IAChC;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YAAC;YAAe;YAAc;YAAU;YAAQ;SAAU;IACtE;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YACR;YACA;YACA;YACA;YACA;YACA;SACD;QACD,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YACR;YACA;YACA;YACA;YACA;YACA;YACA;SACD;IACH;IAEA,iCAAiC;IACjC;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YAAC;YAAU;YAAQ;SAAe;IAC9C;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YAAC;YAAW;YAAQ;SAAe;IAC/C;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YAAC;YAAW;YAAQ;SAAe;IAC/C;IACA;QACE,IAAI;QACJ,MAAM;QACN,aAAa;QACb,cAAc;QACd,UAAU;YAAC;YAAY;YAAQ;SAAe;IAChD;CACD","debugId":null}},
    {"offset": {"line": 269, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/payment/xunhupay/create/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { createServerClient } from \"@/lib/supabase/server\"\nimport { createXunhupayOrder } from \"@/lib/xunhupay\"\nimport { PRODUCTS } from \"@/lib/products\"\nimport { createClient } from \"@supabase/supabase-js\" \n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams\n    const productId = searchParams.get(\"productId\")\n    const paymentType = (searchParams.get(\"type\") || \"alipay\") as \"alipay\" | \"wechat\"\n    const urlUserId = searchParams.get(\"userId\")\n\n    // 1. 检查配置\n    if (!process.env.XUNHUPAY_APPID || !process.env.XUNHUPAY_APPSECRET) {\n      return NextResponse.json({ \n        error: \"配置缺失：请检查 .env.local 文件并重启项目！\" \n      }, { status: 500 })\n    }\n\n    if (!productId) {\n      return NextResponse.json({ error: \"缺少产品ID\" }, { status: 400 })\n    }\n\n    // 2. 获取用户\n    const supabase = await createServerClient()\n    const { data: { user } } = await supabase.auth.getUser()\n    \n    let finalUserId = user?.id\n    if (!finalUserId && urlUserId) finalUserId = urlUserId\n\n    if (!finalUserId) {\n      // 如果没用户，返回 401 告诉前端去登录\n      return NextResponse.json({ error: \"用户未登录\", code: \"UNAUTHORIZED\" }, { status: 401 })\n    }\n\n    const product = PRODUCTS.find((p) => p.id === productId)\n    if (!product) {\n      return NextResponse.json({ error: \"产品不存在\" }, { status: 404 })\n    }\n\n    const orderNo = `XH${Date.now()}${Math.random().toString(36).substring(2, 6).toUpperCase()}`\n\n    // 3. 【防卡死优化】数据库写入不再使用 await\n    // 即使数据库很慢，也不会卡住支付流程\n    const adminAuthClient = process.env.SUPABASE_SERVICE_ROLE_KEY \n      ? createClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL!, \n          process.env.SUPABASE_SERVICE_ROLE_KEY,\n          { auth: { persistSession: false } }\n        )\n      : null\n    const dbClient = adminAuthClient || supabase\n\n    // 异步执行，不阻塞主线程\n    dbClient.from(\"orders\").insert({\n      order_no: orderNo,\n      user_id: finalUserId,\n      product_id: product.id,\n      product_name: product.name,\n      amount: product.priceInCents / 100,\n      payment_method: `xunhupay_${paymentType}`,\n      status: \"pending\",\n    }).then(({ error }) => {\n      if (error) console.error(\"订单记录失败(不影响支付):\", error)\n    })\n\n    // 4. 生成支付链接\n    const cleanSubject = product.name.substring(0, 30);\n    const cleanBody = (product.description || product.name).substring(0, 50);\n\n    const paymentUrl = await createXunhupayOrder({\n      outTradeNo: orderNo,\n      totalAmount: (product.priceInCents / 100).toFixed(2),\n      subject: cleanSubject,\n      body: cleanBody,\n      paymentType,\n    })\n\n    // 5. 【关键】返回 JSON 给前端，让前端去跳转\n    return NextResponse.json({ url: paymentUrl })\n\n  } catch (error: any) {\n    console.error(\"[API Error]\", error)\n    return NextResponse.json({ \n      error: error?.message || \"支付创建失败\" \n    }, { status: 500 })\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;QACjD,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,cAAe,aAAa,GAAG,CAAC,WAAW;QACjD,MAAM,YAAY,aAAa,GAAG,CAAC;QAEnC,UAAU;QACV,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI,CAAC,QAAQ,GAAG,CAAC,kBAAkB,EAAE;YAClE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,IAAI,CAAC,WAAW;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAS,GAAG;gBAAE,QAAQ;YAAI;QAC9D;QAEA,UAAU;QACV,MAAM,WAAW,MAAM,IAAA,iJAAkB;QACzC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAEtD,IAAI,cAAc,MAAM;QACxB,IAAI,CAAC,eAAe,WAAW,cAAc;QAE7C,IAAI,CAAC,aAAa;YAChB,uBAAuB;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAS,MAAM;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,UAAU,6HAAQ,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;QAC9C,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAQ,GAAG;gBAAE,QAAQ;YAAI;QAC7D;QAEA,MAAM,UAAU,CAAC,EAAE,EAAE,KAAK,GAAG,KAAK,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG,GAAG,WAAW,IAAI;QAE5F,4BAA4B;QAC5B,oBAAoB;QACpB,MAAM,kBAAkB,QAAQ,GAAG,CAAC,yBAAyB,GACzD,IAAA,yMAAY,gFAEV,QAAQ,GAAG,CAAC,yBAAyB,EACrC;YAAE,MAAM;gBAAE,gBAAgB;YAAM;QAAE,KAEpC;QACJ,MAAM,WAAW,mBAAmB;QAEpC,cAAc;QACd,SAAS,IAAI,CAAC,UAAU,MAAM,CAAC;YAC7B,UAAU;YACV,SAAS;YACT,YAAY,QAAQ,EAAE;YACtB,cAAc,QAAQ,IAAI;YAC1B,QAAQ,QAAQ,YAAY,GAAG;YAC/B,gBAAgB,CAAC,SAAS,EAAE,aAAa;YACzC,QAAQ;QACV,GAAG,IAAI,CAAC,CAAC,EAAE,KAAK,EAAE;YAChB,IAAI,OAAO,QAAQ,KAAK,CAAC,kBAAkB;QAC7C;QAEA,YAAY;QACZ,MAAM,eAAe,QAAQ,IAAI,CAAC,SAAS,CAAC,GAAG;QAC/C,MAAM,YAAY,CAAC,QAAQ,WAAW,IAAI,QAAQ,IAAI,EAAE,SAAS,CAAC,GAAG;QAErE,MAAM,aAAa,MAAM,IAAA,wIAAmB,EAAC;YAC3C,YAAY;YACZ,aAAa,CAAC,QAAQ,YAAY,GAAG,GAAG,EAAE,OAAO,CAAC;YAClD,SAAS;YACT,MAAM;YACN;QACF;QAEA,4BAA4B;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,KAAK;QAAW;IAE7C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,eAAe;QAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO,OAAO,WAAW;QAC3B,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF","debugId":null}}]
}