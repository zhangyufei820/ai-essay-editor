{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/aixingren/ai-essay-editor/app/api/payment/xunhupay/create/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport crypto from \"crypto\";\n\n// å‡è®¾æ‚¨çš„å•†å“åˆ—è¡¨\nconst PRODUCTS = [\n    { id: \"monthly_vip\", name: \"åŸºç¡€ç‰ˆä¼šå‘˜\", priceInCents: 2800 },\n    { id: \"pro\", name: \"ä¸“ä¸šç‰ˆ\", priceInCents: 6800 },\n];\n\n// =================================================================\n// 1. ç­¾åç®—æ³• (ä¸¥æ ¼éµç…§è™çš®æ¤’å®˜æ–¹ PHP Demo é€»è¾‘)\n// =================================================================\nfunction gen_sign(params: any, appSecret: string) {\n  // 1. æŒ‰ç…§ ASCII ç æ’åº\n  const sortedKeys = Object.keys(params).sort();\n  \n  let str = \"\";\n  for (const key of sortedKeys) {\n    // 2. è¿‡æ»¤æ‰ç©ºå€¼ã€undefinedã€hash\n    if (params[key] !== \"\" && params[key] !== undefined && key !== \"hash\") {\n      str += `${key}=${params[key]}&`;\n    }\n  }\n  \n  // 3. æ‹¼æ¥å¯†é’¥ï¼šå®˜æ–¹æ–‡æ¡£è¦æ±‚åç¼€ä¸º hash_key\n  str += `hash_key=${appSecret}`;\n  \n  // 4. MD5 åŠ å¯†å¹¶è½¬ **å°å†™** (å®˜æ–¹é»˜è®¤æ˜¯å°å†™)\n  return crypto.createHash(\"md5\").update(str, \"utf8\").digest(\"hex\").toLowerCase();\n}\n\n// =================================================================\n// 2. æ”¯ä»˜ API ä¸»é€»è¾‘\n// =================================================================\nexport async function GET(request: Request) {\n  try {\n    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è´¦å·ä¿¡æ¯ (è¯·ç¡®ä¿æ— ç©ºæ ¼) ğŸ‘‡ğŸ‘‡ğŸ‘‡\n    const APP_ID = \"201906175339\"; \n    const APP_SECRET = \"5f9c2b5d451978f6f369375cf7247cf7\"; \n    // -------------------------------------------------------------\n\n    const { searchParams } = new URL(request.url);\n    const productId = searchParams.get(\"productId\");\n\n    // é»˜è®¤å•†å“é€»è¾‘\n    const product = PRODUCTS.find((p) => p.id === productId);\n    const price = product ? (product.priceInCents / 100).toFixed(2) : \"0.01\";\n    \n    // æ ‡é¢˜ï¼šä½¿ç”¨çº¯è‹±æ–‡ï¼Œé˜²æ­¢ç¼–ç é—®é¢˜å¯¼è‡´ç­¾åé”™è¯¯\n    const safeTitle = \"VIP_Service\"; \n    const tradeOrderId = `ORDER_${Date.now()}_${Math.floor(Math.random() * 1000)}`;\n\n    // 3. ç»„è£…å‚æ•° (ä¸è¦åŒ…å« hash)\n    const params: any = {\n      version: \"1.1\",\n      appid: APP_ID,\n      trade_order_id: tradeOrderId,\n      total_fee: price,\n      title: safeTitle,\n      time: Math.floor(Date.now() / 1000).toString(),\n      nonce_str: Math.floor(Math.random() * 1000000).toString(),\n      type: \"WAP\", \n      wap_url: \"http://localhost:3000\", \n      notify_url: \"http://localhost:3000/api/payment/callback\", \n    };\n\n    // 4. è®¡ç®—ç­¾å\n    params.hash = gen_sign(params, APP_SECRET);\n\n    // 5. æœåŠ¡ç«¯å‘èµ· POST è¯·æ±‚\n    console.log(\"ğŸš€ [åç«¯] æ­£åœ¨å‘è™çš®æ¤’å‘èµ· POST è¯·æ±‚:\", params);\n\n    // å°†å‚æ•°è½¬æ¢ä¸º URLSearchParams (æ¨¡æ‹Ÿè¡¨å•æäº¤)\n    const formData = new URLSearchParams(params);\n\n    const response = await fetch(\"https://api.xunhupay.com/payment/do.html\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        // éƒ¨åˆ†é˜²ç«å¢™éœ€è¦ Referer\n        \"Referer\": \"http://localhost:3000\",\n      },\n      body: formData,\n    });\n\n    // 6. å¤„ç†å“åº” (å…³é”®ï¼šå¤„ç†éæ ‡å‡† HTTP å“åº”)\n    const responseText = await response.text();\n    console.log(\"ğŸš€ [åç«¯] æ”¯ä»˜ç½‘å…³å“åº”å†…å®¹:\", responseText);\n\n    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æç¤º\n    if (responseText.includes(\"é”™è¯¯çš„ç­¾å\") || responseText.includes(\"invalid\")) {\n       throw new Error(`æ”¯ä»˜ç½‘å…³æ‹’ç»: ${responseText}`);\n    }\n\n    // 7. å°è¯•è§£æ JSON è·å–è·³è½¬é“¾æ¥\n    let data;\n    try {\n        data = JSON.parse(responseText);\n    } catch (e) {\n        // å¦‚æœæ— æ³•è§£æ JSONï¼Œè¯´æ˜ç½‘å…³è¿”å›äº† HTML æˆ–å…¶ä»–å†…å®¹\n        console.error(\"JSONè§£æå¤±è´¥ï¼ŒåŸå§‹å“åº”:\", responseText);\n        throw new Error(\"æ— æ³•è·å–æ”¯ä»˜é“¾æ¥ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—\");\n    }\n\n    // è™çš®æ¤’é€šå¸¸è¿”å› url (H5è·³è½¬) æˆ– url_qrcode (PCæ‰«ç )\n    const finalPayUrl = data.url || data.url_qrcode;\n\n    if (!finalPayUrl) {\n        throw new Error(\"æœªæ¥æ”¶åˆ°æ”¯ä»˜é“¾æ¥ (url å­—æ®µä¸ºç©º)\");\n    }\n\n    // 8. æˆåŠŸï¼è¿”å›ç»™å‰ç«¯\n    return NextResponse.json({ \n      url: finalPayUrl,\n      trade_order_id: tradeOrderId \n    });\n\n  } catch (error: any) {\n    console.error(\"âŒ API Error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}